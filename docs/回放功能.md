# SonoScope 回放功能蓝图

> 目标：既能轻量回放“音频 + 弹幕”，也能在桌面端生成可分享的视频，并兼顾跨端兼容与后续扩展。

---

## 1. 两类能力
1. **录音 + 弹幕回放（优先上线）**
   - 记录麦克风音频和弹幕时间轴，提供“原样重放”的互动体验。
2. **录屏 + 录音生成视频（进阶能力）**
   - 同步录制画面与音频，导出可分享的视频（WebM/MP4）。

---

## 2. 浏览器约束与降级策略
- **HTTPS + 用户手势**：所有媒体接口的前提。
- **桌面 Chrome / Edge / Firefox**：`getUserMedia`、`canvas.captureStream`、`MediaRecorder` 均可用，优先支持完整功能。
- **Safari / iOS**：
  - iOS 16+ 才开始支持 `MediaRecorder`，iOS 17 以后 `getDisplayMedia` 才勉强可用。
  - 规划降级：若无法录屏，则仅提供“录音 + 弹幕回放”，或提示使用系统录屏 / 服务端渲染方案。
- **能力检测**：在 UI 中根据可用接口动态启用按钮，避免用户踩坑。

---

## 3. 通用事件模型（建议阶段 A 就固定）
```json
{
  "session": {
    "version": 1,
    "startedAt": 1690000000000,
    "visualPreset": "wave",
    "seed": "abc123",
    "canvasSize": { "w": 1280, "h": 720 },
    "fps": 60
  },
  "audio": {
    "mimeType": "audio/webm",
    "durationMs": 245000,
    "sampleRate": 48000
  },
  "events": [
    { "t": 15342, "type": "danmu_add", "payload": { "id": "d1", "text": "好听" } },
    { "t": 19670, "type": "danmu_remove", "payload": { "id": "d1" } }
  ]
}
```
- **t**：相对录制起点的毫秒。
- 记录视觉 preset、随机种子、画布尺寸，保证回放时视觉可重现。
- 后续如要扩展歌词、手势等事件，直接追加新的 `type` 与 `payload`。

---

## 4. 方案 A：录音 + 弹幕回放（MVP）
### 4.1 采集
- 麦克风：`navigator.mediaDevices.getUserMedia({ audio: true })`；`MediaRecorder` 分片写入（`.webm`）。
- 弹幕事件：在现有弹幕管线处挂载监听器，实时 push `{ t, type, payload }`；可额外记录 preset 切换、感知模式等状态事件。

### 4.2 存储
- **本地**：IndexedDB 分片写入（避免长时录制占满内存），并在停止录制时组装 Blob + JSON。
- **上传**：音频 Blob 与事件 JSON 一并 POST 给后端；持久化后返回可分享链接。
- 提供清理逻辑，录制失败或取消时要删除暂存分片，防止占空间。

### 4.3 回放
- 以音频播放进度为主时钟：
  - 常规情况：使用 `audio.currentTime`。
  - Safari/后台页：备选 `requestAnimationFrame` + 累积 `performance.now()`，确保暂停/后台恢复时仍准确。
- 弹幕渲染沿用实时逻辑，按事件 `t` 触发；
- 若需要“录制模式”，可降低特效以保证录制期间性能。

### 4.4 优势
- 跨端稳定、文件体积小；
- 便于后续编辑（可改文本或删弹幕再导出）。

---

## 5. 方案 B：录屏 + 录音生成视频（进阶）
### 5.1 画面与音频源
- 若可视化集中在单个 canvas：`canvas.captureStream(60)` 获取视频；
- 若需要包含 UI：`getDisplayMedia({ video: true, audio: false })` 选择标签页或窗口；
- 音频：`getUserMedia({ audio: true })`，必要时通过 `AudioContext` 混合系统音与麦克风。

### 5.2 录制与导出
- `new MediaRecorder(mixedStream, { mimeType: 'video/webm;codecs=vp9,opus' })` 分片输出；
- 导出 `.webm`，若需 `.mp4`：
  - 前端 `ffmpeg.wasm` 转码（≤2 分钟以内体验可接受）；
  - 或上传后端使用 FFmpeg 转码（推荐长期方案）。

### 5.3 服务端 / 离线渲染（备选）
- 使用 Headless 浏览器或 Node-Canvas 还原弹幕与可视化，再用 FFmpeg 合成；
- 输入：音频 + 事件 JSON；输出：统一画质 MP4；
- 成本高但可解决 Safari、性能、字体一致性问题。

### 5.4 性能与体积
- 录屏时建议限制分辨率（720p/30fps）以防掉帧；
- 分片写入 IndexedDB 并显示进度条，避免一次性写内存；
- 录制中提示“性能模式”降低粒子数量或着色器复杂度。

---

## 6. 隐私与合规
- 只录当前 tab/画布；显著展示“录制中”水印或红点。
- 弹幕回放/分享前需再次确认内容，避免私聊敏感信息泄漏。
- 建议提供“删除录制”选项，并在回放列表里标明可见范围。

---

## 7. 推荐实施节奏
| 阶段 | 重点 | 工时估算 |
| --- | --- | --- |
| A (约 1 周) | 录音 + 弹幕回放：录制控制 UI、事件模型、IndexedDB 存储、回放播放器 | 5-7 人日 |
| B (1-2 周) | 录屏 + 录音：桌面端优先，WebM 导出，服务端转码接口 | 7-10 人日 |
| C (择机) | 服务端渲染、iOS Fallback 引导、视频编辑工具 | 视需求 |

---

## 8. 用户体验草图
- 页面右上角新增“录制”按钮：
  - 录制模式选择（仅音频 / 屏幕+麦克风）。
  - 显示录制时长、性能模式提示。
- 停止后提供：
  - 预览回放（音频+弹幕同步）。
  - 下载音频 / 视频。
  - 生成分享链接（上传成功后展示）。
- 回放页支持弹幕过滤、密度控制，未来可接入视频导出。

---

## 9. 风险提示与缓解
- **接口不可用**：提前做 feature detect，界面提示降级或引导系统录屏。
- **帧率波动**：录制时启用“性能模式”或提示用户降低画质。
- **长时录制**：确保分片写入、定期 flush，并提供取消/清理按钮。
- **回放同步误差**：
  - 记录精确 `startedAt`，回放时使用统一的时钟源；
  - 出现漂移时可在 UI 提供“校准”按钮（调整偏移几百毫秒）。

通过阶段化上线和统一事件模型，我们可以先确保“录音 + 弹幕回放”的稳定体验，再视平台能力扩展至“录屏 + 录音”的分享成片。这样既兼顾了跨端兼容，也为后续服务端渲染、视频编辑留出了接口和数据基础。
