# 弹幕去重与人格化落地 TODO（Route 侧）

> 目标：在不破坏现有接口形态的前提下，显著降低模板化与重复度，提升“有人味”的陪伴感。

## 阶段划分与里程碑

- [x] Phase 1（基础能力，优先上线）
  - [x] 扩展接口参数（兼容默认值），读取以下字段：
    - [x] `personaId: 'auto'|'quiet'|'cheer'|'steady'|'playful'`
    - [x] `existingDanmu: string[]`（最近 30–50 条文本）
    - [x] `maxLength: number`（默认 42，区间 30–60）
    - [x] `enableDedup: boolean`（默认 true）
    - [x] `dedupNgram: number`（默认 3）
    - [x] `dedupAgainstHistory: boolean`（默认 true）
    - [x] `dedupAgainstBatch: boolean`（默认 true）
    - [x] `enableEmojiControl: boolean`（默认 true）
    - [x] `maxEmojiPerItem: number`（默认 0，禁止 Emoji）
    - [x] `maxEmojiRatio: number`（默认 0，禁止 Emoji）
    - [x] `encouragementExtraMin: number`（默认 1）
    - [x] `encouragementExtraMax: number`（默认 2）
  - [x] 构造 PERSONAS 表并接入：
    - [x] `quiet`（安静细腻，轻声细语，常用“嗯”“慢慢来”）
    - [x] `cheer`（开朗热情，注意不过度感叹）
    - [x] `steady`（稳重可靠，短句有力量）
    - [x] `playful`（活泼脑洞，轻度自我调侃）
    - [x] `auto` 时：依据会话 seed 或随机选择
  - [x] 升级 Prompt（系统 + 用户）：
    - [x] 系统提示：严格 JSON 数组，禁止解释/Markdown，`text/style/color/size/speed/cooldownMs` 字段约束；文本不得含换行与首尾空白；主要中文。
    - [x] 用户提示：
      - [x] 注入 persona 风格提示与“陪伴语气（我/你/我们、共感）”
      - [x] 指定：句长 6–20 字、口语停顿词最多 1 个/条、Emoji 禁止（0 个/条、总体 0%）
      - [x] 明确：鼓励/陪伴型使用 `style=manual` 与柔和配色
      - [x] 明确：避免与 `existingDanmu` 出现 3-gram 以上重叠
      - [x] 明确：结合音频特征用隐喻/比拟而非技术词
  - [x] 解析容错：允许字符串包裹、对象嵌套字段（如 `data`/`items`），统一提取数组。
  - [x] 文本归一化工具：
    - [x] 全角→半角、大小写统一、去重复空白、去首尾标点、统一省略号为“…”。
    - [x] 字素簇切分，保证 Emoji/合成字符不被截断。
  - [x] N-gram 去重：
    - [x] 与历史去重（`existingDanmu`，n=3）
    - [x] 与同批去重（n=3）
  - [x] Emoji/标点规则：
    - [ ] 禁止 Emoji：每条 0 个、总体 0%，发现则剔除或清洗
    - [ ] 连续标点压缩：`！！！`→`！`，`......`→`…`
  - [x] 长度与字段校验：按字素簇计数截断到 `maxLength`；缺失 `color/size/speed/cooldownMs` 时兜底。
  - [x] 回退与补单：若过滤后低于目标 80%，触发一次补单（携带新“避免重合”列表），或从未过滤版本回填低权条目。
  - [x] 返回体增强：附加 `personaId`、`filteredCount`、`dedupedCount`、`reRequest` 标识。

- [x] Phase 2（调优与可控多样化）
  - [x] 采样参数可配：`temperature/top_p/frequency_penalty/presence_penalty`
  - [x] 句式模板黑名单与降权（20–50 条常见模板正则）
  - [x] Persona “会话级固定 + 批次级抖动（10–20%）”：新增 `personaDiversity: 0..1`
  - [x] 评分排序：第一/第二人称加分、陪伴词加分、过度标点/emoji 扣分，按综合分排序返回。

- [ ] Phase 3（实验与沉淀）
  - [ ] AB 分流：`abBucket` 参数接入不同策略对照实验
  - [ ] 指标记录：3-gram 重复率、Emoji 违规率、长度超限率、解析失败率；在日志或前端调试面板展示
  - [ ] 会话历史学习：`historyWindow` 与缓存，避免跨会话污染

## 文件与实现位置

- 后端接口：`app/app/api/llm-danmu/route.ts`
  - [x] 读取新参数与默认值
  - [x] 构造 `PERSONAS` 与 `personaHint`
  - [x] 拼装系统/用户 Prompt（保留原有 features 线索）
  - [ ] 解析容错 + 归一化 + 去重 + 质量校验 + 兜底与补单
  - [x] 返回增强字段（不破坏原字段）

## Prompt 片段（放入 route.ts）

- 系统提示要点（示例）：
  - 严格输出 JSON 数组，元素字段：`text/style/color/size/speed/cooldownMs`
  - `style` 限定：`beat|voice|complexity|random|manual`
  - 文本不含换行、无首尾空白，主要中文
  - 禁止任何解释/Markdown/注释

- 用户提示要点（示例）：
  - 角色：注入 `personaHint`（安静/开朗/稳重/活泼 等），使用第一/第二人称与共感语气
  - 生成：`{needDanmu}` 条常规 + `{encouragementExtraMin}-{encouragementExtraMax}` 条鼓励/陪伴型
  - 句式：6–20 字；口语停顿词每条 ≤1；Emoji 禁止（0 个、总体 0%）
  - 多样性：避免与“历史弹幕”3-gram 重叠，避免同批重复
  - 语义：结合音频特征做隐喻/比拟，避免技术名词直译
  - 输出：仅 JSON 数组

## 验收标准（KPI）

- [ ] 3-gram 重复率（含历史 + 同批）< 10%
- [ ] 第一/第二人称覆盖率 ≥ 80%
- [ ] 解析失败率（非数组/字段缺失）< 2%
- [ ] 长度/标点违规率 < 5%，Emoji 违规率 = 0%
- [ ] 主观自然度 ≥ 4/5，persona 能被区分
- [ ] 旧参数兼容：不传扩展参数时行为不变

## 回滚与开关

- [ ] 增加环境开关 `LLM_DANMU_ENHANCE=true|false`，问题时可快速回退
- [ ] 每一项子能力以参数级开关控制（去重 / 评分 / 采样惩罚等）

## 参考实现片段

```ts
// 归一化 + n-gram 去重（示例签名）
function normalizeText(input: string): string { /* 全角→半角、空白压缩、标点压缩、“…”统一等 */ return input; }
function extractGraphemes(input: string): string[] { /* Intl.Segmenter or fallback */ return [];
}
function extractNGram(text: string, n = 3): string[] { const g = extractGraphemes(normalizeText(text)); /* ... */ return []; }

function dedupe(list: LlmDanmu[], history: string[], n = 3) {
  const seen = new Set(history.flatMap(t => extractNGram(t, n)));
  return list.filter(item => {
    const grams = extractNGram(item.text, n);
    const dup = grams.some(g => seen.has(g));
    if (!dup) grams.forEach(g => seen.add(g));
    return !dup;
  });
}
```

## 上线步骤建议

- [ ] 提交 Phase 1，打灰度开关，预置默认参数（兼容旧版本）
- [ ] 收集日志指标并人工抽样
- [ ] 评估后放量，并开始 Phase 2 调优


