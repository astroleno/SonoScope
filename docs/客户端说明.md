# SonoScope 客户端说明

## 概述

SonoScope 现在提供两个独立的前端应用，分别服务于不同的使用场景：

1. **原始应用** - 完整的开发测试环境
2. **客户端外壳** - 基于SDK的独立客户端，用于客户定制

## 🏗️ 架构设计

### 核心SDK包 (`packages/sdk`)
- **职责**: 提供统一的音频处理、可视化和弹幕功能
- **特点**: 解耦、可复用、类型安全
- **接口**: 标准化的API，支持多种传输方式

### 客户端应用
- **原始应用**: 直接使用底层包，功能完整
- **客户端外壳**: 通过SDK调用，架构清晰

## 📁 文件结构

```
SonoScope/
├── packages/
│   ├── sdk/                    # 核心SDK包
│   │   ├── src/
│   │   │   ├── core.ts         # 核心类
│   │   │   ├── types.ts        # 类型定义
│   │   │   ├── adapters/       # 适配器
│   │   │   └── transports/     # 传输层
│   │   └── package.json
│   ├── core/                   # 事件总线
│   ├── danmu-pipeline/         # 弹幕引擎
│   ├── visuals-basic/          # 基础可视化
│   └── visuals-trap/           # 高级可视化
├── app/
│   ├── app/                    # 原始应用
│   │   ├── page.tsx           # 主页面
│   │   ├── layout.tsx         # 布局
│   │   └── api/               # API路由
│   └── client-shell/          # 客户端外壳
│       ├── page.tsx           # 客户端页面
│       └── layout.tsx         # 客户端布局
└── docs/
    └── 客户端说明.md          # 本文档
```

## 🚀 启动方式

### 开发环境
```bash
# 安装依赖
pnpm install

# 启动开发服务器
cd app && pnpm run dev
```

### 访问地址
- **原始应用**: `http://localhost:3004/`
- **客户端外壳**: `http://localhost:3004/client-shell`

## 🎯 功能对比

| 功能 | 原始应用 | 客户端外壳 |
|------|----------|------------|
| **音频处理** | 直接集成Meyda | 通过SDK WebAudioAdapter |
| **可视化** | 直接调用visuals包 | 通过SDK SimpleVisualAdapter |
| **弹幕** | 直接使用danmu-pipeline | 通过SDK SimpleDanmuAdapter |
| **状态管理** | 本地React状态 | SDK事件系统 |
| **主题** | 硬编码样式 | 可配置主题令牌 |
| **设备选择** | 完整设备管理 | 简化设备选择 |
| **控制面板** | 详细参数调节 | 基础控制选项 |

## 🔧 SDK使用示例

### 基本用法
```typescript
import { Core, SimpleVisualAdapter, EnhancedDanmuAdapter } from '@sonoscope/sdk';

// 创建核心实例
const core = new Core({
  themeTokens: {
    neonBlue: '#00D4FF',
    neonPurple: '#8B5CF6',
    // ... 更多主题配置
  },
  sensitivity: 1.5,
});

// 初始化
await core.init();

// 设置音频源
await core.setAudioSource({
  type: 'device',
  options: {
    echoCancellation: true,
    noiseSuppression: true,
  }
});

// 设置可视化
const visualAdapter = new SimpleVisualAdapter(p5Instance);
core.setVisualAdapter(visualAdapter);
core.setPreset('pulse');

// 设置增强弹幕
const danmuAdapter = new EnhancedDanmuAdapter();
danmuAdapter.onDanmu((event) => {
  console.log('Generated danmu:', event);
});
core.setDanmuAdapter(danmuAdapter);

// 启动
await core.start();
danmuAdapter.start();
```

### 事件监听
```typescript
// 监听音频特征
core.on('features', (features) => {
  console.log('音频特征:', features);
  // 自动处理弹幕生成
  if (danmuAdapter) {
    danmuAdapter.handleAudioFeatures(features.rms || 0, features);
  }
});

// 监听弹幕事件
core.on('danmu', (event) => {
  console.log('弹幕事件:', event);
  // 显示弹幕到UI
  displayDanmu(event);
});

// 监听日志
core.on('log', (level, message, data) => {
  console.log(`[${level}] ${message}`, data);
});
```

### 智能弹幕生成
```typescript
// 基于音频特征的智能弹幕
const danmuAdapter = new EnhancedDanmuAdapter();

// 弹幕触发规则
// 1. 节拍强度变化 > 0.2 → 节奏类弹幕
// 2. 人声概率变化 > 0.3 → 人声类弹幕  
// 3. 复杂度变化 > 0.2 → 复杂度类弹幕
// 4. 随机触发 (5%概率) → 随机音乐弹幕

// 手动触发弹幕
danmuAdapter.trigger({
  text: '🎵 手动触发弹幕',
  style: 'manual',
  color: '#ff6b6b',
  size: 18,
});

// 获取特征摘要
const summary = danmuAdapter.generateFeatureSummary(coreFeatures);
console.log(summary); // "bpm=128; instrument=drums; voice=45%; beat=78%"
```

## 🎨 主题定制

### 主题令牌
```typescript
const customTheme = {
  neonBlue: '#00D4FF',      // 霓虹蓝
  neonPurple: '#8B5CF6',    // 霓虹紫
  neonPink: '#FF006E',      // 霓虹粉
  neonGreen: '#39FF14',     // 霓虹绿
  bgDark: '#0A0A0F',        // 深色背景
  bgMedium: '#1A1A2E',      // 中等背景
  bgLight: '#16213E',       // 浅色背景
  textPrimary: '#ffffff',   // 主文本色
  textSecondary: '#cccccc', // 次文本色
  borderColor: 'rgba(255, 255, 255, 0.1)', // 边框色
  accentColor: '#00D4FF',   // 强调色
};
```

### 应用主题
```typescript
core.setConfig({
  themeTokens: customTheme
});
```

## 🔌 适配器系统

### 音频适配器
- **WebAudioAdapter**: 基于Web Audio API和Meyda
- **特性**: 设备选择、回退机制、特征提取

### 可视化适配器
- **SimpleVisualAdapter**: 基础P5.js可视化
- **支持预设**: pulse, accretion, mosaic, spiral
- **特性**: 实时渲染、音频响应

### 弹幕适配器
- **SimpleDanmuAdapter**: 基础模拟弹幕生成
- **EnhancedDanmuAdapter**: 智能弹幕生成，基于音频特征
- **特性**: 自动触发、手动触发、音频响应、特征驱动

### 传输适配器
- **MemoryTransport**: 同线程通信
- **WorkerTransport**: Web Worker通信
- **特性**: 事件驱动、类型安全

## 📦 构建和部署

### SDK构建
```bash
cd packages/sdk
pnpm run build
```

### 客户端构建
```bash
cd app
pnpm run build
```

### 生产部署
- 原始应用和客户端外壳可以独立部署
- 共享同一个SDK包
- 支持CDN分发

## 🚀 扩展开发

### 添加新可视化
1. 在 `packages/visuals-*` 中实现
2. 在SDK中创建适配器
3. 在客户端中集成

### 添加新传输方式
1. 实现 `Transport` 接口
2. 在SDK中注册
3. 配置使用

### 客户定制
1. 基于客户端外壳创建新应用
2. 自定义主题和UI
3. 配置功能开关

## 🔍 调试和监控

### 日志系统
```typescript
core.on('log', (level, message, data) => {
  // 处理日志
  if (level === 'error') {
    console.error(message, data);
  }
});
```

### 状态监控
```typescript
// 获取核心状态
console.log('初始化状态:', core.initialized);
console.log('运行状态:', core.running);
console.log('当前特征:', core.features);
console.log('弹幕状态:', core.danmuStatus);
```

## 📋 最佳实践

### 1. 错误处理
```typescript
try {
  await core.start();
} catch (error) {
  console.error('启动失败:', error);
  // 处理错误
}
```

### 2. 资源清理
```typescript
// 组件卸载时清理
useEffect(() => {
  return () => {
    core.dispose();
  };
}, []);
```

### 3. 性能优化
- 使用事件节流
- 合理设置缓冲区大小
- 避免频繁的DOM操作

## 🆘 常见问题

### Q: 音频设备无法访问？
A: 检查浏览器权限，确保已授权麦克风访问

### Q: 可视化不显示？
A: 检查P5.js是否正确加载，确保画布容器存在

### Q: 弹幕不生成？
A: 检查音频特征是否正常，确保弹幕适配器已启动

### Q: 主题不生效？
A: 检查CSS变量是否正确设置，确保主题令牌有效

## 📞 技术支持

如有问题，请参考：
- 项目文档: `docs/` 目录
- 代码示例: `app/client-shell/` 目录
- 类型定义: `packages/sdk/src/types.ts`

---

*最后更新: 2024年12月*
