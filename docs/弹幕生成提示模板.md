# 弹幕生成提示模板

## 概述

基于特征目录弹幕可用部分的建议，本文档提供了智能弹幕生成的提示模板和触发规则。

## 核心特征映射

### 最小可用输入特征
```typescript
interface DanmuCoreFeatures {
  // 风格检测
  style?: {
    label: string;        // 音乐风格标签
    confidence: number;   // 置信度 0-1
  };
  
  // 乐器检测
  instruments?: {
    primary: string;                    // 主乐器
    secondary?: string;                 // 次乐器
    probabilities: Record<string, number>; // 乐器概率分布
    confidence: number;                 // 置信度 0-1
  };
  
  // 节拍信息
  tempo?: {
    bpm: number;          // 每分钟节拍数
    beatStrength: number; // 节拍强度 0-1
  };
  
  // 人声检测
  voice?: {
    probability: number;  // 人声存在概率 0-1
  };
  
  // 打击/谐波分离
  hpss?: {
    percussiveRatio: number; // 打击乐比例 0-1
    harmonicRatio: number;   // 谐波比例 0-1
  };
  
  // 音色特征
  timbre?: {
    warmth: number;      // 温暖度 0-1
    brightness: number;  // 亮度 0-1
    roughness: number;   // 粗糙度 0-1
  };
}
```

## 弹幕生成规则

### 1. 节拍强度触发 (beatStrength)
**触发条件**: `Math.abs(currentBeatStrength - lastBeatStrength) > 0.2`

**弹幕类型**: 节奏类弹幕
```javascript
const beatTexts = [
  `🎵 BPM: ${Math.round(bpm)}`,
  `💥 节拍强度: ${Math.round(beatStrength * 100)}%`,
  `🔥 节奏感爆棚！`,
  `⚡ 节拍同步中...`,
  `🎶 律动感十足`,
];

// 颜色映射
const color = beatStrength > 0.7 ? '#ff6b6b' : '#4ecdc4';
const size = 16 + beatStrength * 8;
const speed = 1 + beatStrength * 0.5;
```

### 2. 人声概率触发 (voiceProb)
**触发条件**: `Math.abs(currentVoiceProb - lastVoiceProb) > 0.3`

**弹幕类型**: 人声类弹幕
```javascript
const voiceTexts = [
  `🎤 人声检测: ${Math.round(voiceProb * 100)}%`,
  `🎵 主唱模式`,
  `🎶 人声清晰`,
  `🎤 声线优美`,
  `🎵 人声主导`,
];

// 颜色映射
const color = voiceProb > 0.7 ? '#ff9ff3' : '#54a0ff';
const size = 16 + voiceProb * 4;
```

### 3. 复杂度变化触发 (complexity)
**触发条件**: `Math.abs(currentComplexity - lastComplexity) > 0.2`

**弹幕类型**: 复杂度类弹幕
```javascript
const complexityTexts = [
  `🎼 复杂度: ${Math.round(complexity * 100)}%`,
  `🎵 乐器数量: ${instrumentCount}`,
  `🎶 编曲丰富`,
  `🎼 层次分明`,
  `🎵 音乐饱满`,
];

// 颜色映射
const color = complexity > 0.7 ? '#ffa502' : '#2ed573';
const size = 16 + complexity * 6;
const speed = 1 + complexity * 0.3;
```

### 4. 随机触发
**触发条件**: `Math.random() < 0.05` (5%概率)

**弹幕类型**: 随机音乐相关弹幕
```javascript
const randomTexts = [
  `🎵 ${primaryInstrument} 主导`,
  `🎶 音乐节拍: ${Math.round(bpm)} BPM`,
  `🎼 音色温暖`,
  `🎵 旋律优美`,
  `🎶 节奏感强`,
];
```

## 特征摘要生成

### 英文Token摘要
用于调试和日志记录：
```javascript
function generateFeatureSummary(core: DanmuCoreFeatures): string {
  const parts = [];
  
  if (core.tempo?.bpm) parts.push(`bpm=${Math.round(core.tempo.bpm)}`);
  if (core.instruments?.primary) parts.push(`instrument=${core.instruments.primary}`);
  if (core.voice?.probability) parts.push(`voice=${Math.round(core.voice.probability * 100)}%`);
  if (core.tempo?.beatStrength) parts.push(`beat=${Math.round(core.tempo.beatStrength * 100)}%`);
  
  return parts.join('; ');
}

// 示例输出: "bpm=128; instrument=drums; voice=45%; beat=78%"
```

## 弹幕样式配置

### 样式类型
```typescript
type DanmuStyle = 'beat' | 'voice' | 'complexity' | 'random' | 'manual';

const styleConfig = {
  beat: {
    baseColor: '#4ecdc4',
    highIntensityColor: '#ff6b6b',
    sizeRange: [16, 24],
    speedRange: [1, 1.5],
  },
  voice: {
    baseColor: '#54a0ff',
    highIntensityColor: '#ff9ff3',
    sizeRange: [16, 20],
    speedRange: [1, 1],
  },
  complexity: {
    baseColor: '#2ed573',
    highIntensityColor: '#ffa502',
    sizeRange: [16, 22],
    speedRange: [1, 1.3],
  },
  random: {
    baseColor: '#ffffff',
    sizeRange: [16, 16],
    speedRange: [1, 1],
  },
  manual: {
    baseColor: '#ff6b6b',
    sizeRange: [18, 18],
    speedRange: [1, 1],
  },
};
```

## 冷却机制

### 全局冷却
- **冷却时间**: 2秒 (`triggerCooldown = 2000ms`)
- **目的**: 防止弹幕过于频繁

### 特征变化检测
- **节拍强度**: 变化阈值 0.2
- **人声概率**: 变化阈值 0.3  
- **复杂度**: 变化阈值 0.2

## 使用示例

### 在客户端中的集成
```typescript
// 创建增强弹幕适配器
const danmuAdapter = new EnhancedDanmuAdapter();

// 监听音频特征
core.on('features', (features) => {
  // 处理增强弹幕特征
  danmuAdapter.handleAudioFeatures(features.rms || 0, features);
});

// 监听弹幕事件
danmuAdapter.onDanmu((event) => {
  console.log('Generated danmu:', event);
  // 显示弹幕到UI
});

// 启动弹幕生成
danmuAdapter.start();
```

### 手动触发
```typescript
danmuAdapter.trigger({
  text: '🎵 手动触发弹幕',
  style: 'manual',
  color: '#ff6b6b',
  size: 18,
});
```

## 扩展建议

### 1. 添加更多触发条件
- 乐器切换检测
- 风格变化检测
- 音色特征变化

### 2. 个性化弹幕内容
- 基于用户偏好的弹幕风格
- 多语言支持
- 表情符号动态选择

### 3. 智能频率控制
- 基于音乐复杂度的动态冷却
- 用户交互频率调整
- 内容质量评分

### 4. 高级特征利用
- 利用增强统计特征
- 多特征组合触发
- 时序模式识别

---

*基于特征目录弹幕可用部分的建议实现*
