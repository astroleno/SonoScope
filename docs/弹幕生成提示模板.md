# å¼¹å¹•ç”Ÿæˆæç¤ºæ¨¡æ¿

## æ¦‚è¿°

åŸºäºç‰¹å¾ç›®å½•å¼¹å¹•å¯ç”¨éƒ¨åˆ†çš„å»ºè®®ï¼Œæœ¬æ–‡æ¡£æä¾›äº†æ™ºèƒ½å¼¹å¹•ç”Ÿæˆçš„æç¤ºæ¨¡æ¿å’Œè§¦å‘è§„åˆ™ã€‚

## æ ¸å¿ƒç‰¹å¾æ˜ å°„

### æœ€å°å¯ç”¨è¾“å…¥ç‰¹å¾
```typescript
interface DanmuCoreFeatures {
  // é£æ ¼æ£€æµ‹
  style?: {
    label: string;        // éŸ³ä¹é£æ ¼æ ‡ç­¾
    confidence: number;   // ç½®ä¿¡åº¦ 0-1
  };
  
  // ä¹å™¨æ£€æµ‹
  instruments?: {
    primary: string;                    // ä¸»ä¹å™¨
    secondary?: string;                 // æ¬¡ä¹å™¨
    probabilities: Record<string, number>; // ä¹å™¨æ¦‚ç‡åˆ†å¸ƒ
    confidence: number;                 // ç½®ä¿¡åº¦ 0-1
  };
  
  // èŠ‚æ‹ä¿¡æ¯
  tempo?: {
    bpm: number;          // æ¯åˆ†é’ŸèŠ‚æ‹æ•°
    beatStrength: number; // èŠ‚æ‹å¼ºåº¦ 0-1
  };
  
  // äººå£°æ£€æµ‹
  voice?: {
    probability: number;  // äººå£°å­˜åœ¨æ¦‚ç‡ 0-1
  };
  
  // æ‰“å‡»/è°æ³¢åˆ†ç¦»
  hpss?: {
    percussiveRatio: number; // æ‰“å‡»ä¹æ¯”ä¾‹ 0-1
    harmonicRatio: number;   // è°æ³¢æ¯”ä¾‹ 0-1
  };
  
  // éŸ³è‰²ç‰¹å¾
  timbre?: {
    warmth: number;      // æ¸©æš–åº¦ 0-1
    brightness: number;  // äº®åº¦ 0-1
    roughness: number;   // ç²—ç³™åº¦ 0-1
  };
}
```

## å¼¹å¹•ç”Ÿæˆè§„åˆ™

### 1. èŠ‚æ‹å¼ºåº¦è§¦å‘ (beatStrength)
**è§¦å‘æ¡ä»¶**: `Math.abs(currentBeatStrength - lastBeatStrength) > 0.2`

**å¼¹å¹•ç±»å‹**: èŠ‚å¥ç±»å¼¹å¹•
```javascript
const beatTexts = [
  `ğŸµ BPM: ${Math.round(bpm)}`,
  `ğŸ’¥ èŠ‚æ‹å¼ºåº¦: ${Math.round(beatStrength * 100)}%`,
  `ğŸ”¥ èŠ‚å¥æ„Ÿçˆ†æ£šï¼`,
  `âš¡ èŠ‚æ‹åŒæ­¥ä¸­...`,
  `ğŸ¶ å¾‹åŠ¨æ„Ÿåè¶³`,
];

// é¢œè‰²æ˜ å°„
const color = beatStrength > 0.7 ? '#ff6b6b' : '#4ecdc4';
const size = 16 + beatStrength * 8;
const speed = 1 + beatStrength * 0.5;
```

### 2. äººå£°æ¦‚ç‡è§¦å‘ (voiceProb)
**è§¦å‘æ¡ä»¶**: `Math.abs(currentVoiceProb - lastVoiceProb) > 0.3`

**å¼¹å¹•ç±»å‹**: äººå£°ç±»å¼¹å¹•
```javascript
const voiceTexts = [
  `ğŸ¤ äººå£°æ£€æµ‹: ${Math.round(voiceProb * 100)}%`,
  `ğŸµ ä¸»å”±æ¨¡å¼`,
  `ğŸ¶ äººå£°æ¸…æ™°`,
  `ğŸ¤ å£°çº¿ä¼˜ç¾`,
  `ğŸµ äººå£°ä¸»å¯¼`,
];

// é¢œè‰²æ˜ å°„
const color = voiceProb > 0.7 ? '#ff9ff3' : '#54a0ff';
const size = 16 + voiceProb * 4;
```

### 3. å¤æ‚åº¦å˜åŒ–è§¦å‘ (complexity)
**è§¦å‘æ¡ä»¶**: `Math.abs(currentComplexity - lastComplexity) > 0.2`

**å¼¹å¹•ç±»å‹**: å¤æ‚åº¦ç±»å¼¹å¹•
```javascript
const complexityTexts = [
  `ğŸ¼ å¤æ‚åº¦: ${Math.round(complexity * 100)}%`,
  `ğŸµ ä¹å™¨æ•°é‡: ${instrumentCount}`,
  `ğŸ¶ ç¼–æ›²ä¸°å¯Œ`,
  `ğŸ¼ å±‚æ¬¡åˆ†æ˜`,
  `ğŸµ éŸ³ä¹é¥±æ»¡`,
];

// é¢œè‰²æ˜ å°„
const color = complexity > 0.7 ? '#ffa502' : '#2ed573';
const size = 16 + complexity * 6;
const speed = 1 + complexity * 0.3;
```

### 4. éšæœºè§¦å‘
**è§¦å‘æ¡ä»¶**: `Math.random() < 0.05` (5%æ¦‚ç‡)

**å¼¹å¹•ç±»å‹**: éšæœºéŸ³ä¹ç›¸å…³å¼¹å¹•
```javascript
const randomTexts = [
  `ğŸµ ${primaryInstrument} ä¸»å¯¼`,
  `ğŸ¶ éŸ³ä¹èŠ‚æ‹: ${Math.round(bpm)} BPM`,
  `ğŸ¼ éŸ³è‰²æ¸©æš–`,
  `ğŸµ æ—‹å¾‹ä¼˜ç¾`,
  `ğŸ¶ èŠ‚å¥æ„Ÿå¼º`,
];
```

## ç‰¹å¾æ‘˜è¦ç”Ÿæˆ

### è‹±æ–‡Tokenæ‘˜è¦
ç”¨äºè°ƒè¯•å’Œæ—¥å¿—è®°å½•ï¼š
```javascript
function generateFeatureSummary(core: DanmuCoreFeatures): string {
  const parts = [];
  
  if (core.tempo?.bpm) parts.push(`bpm=${Math.round(core.tempo.bpm)}`);
  if (core.instruments?.primary) parts.push(`instrument=${core.instruments.primary}`);
  if (core.voice?.probability) parts.push(`voice=${Math.round(core.voice.probability * 100)}%`);
  if (core.tempo?.beatStrength) parts.push(`beat=${Math.round(core.tempo.beatStrength * 100)}%`);
  
  return parts.join('; ');
}

// ç¤ºä¾‹è¾“å‡º: "bpm=128; instrument=drums; voice=45%; beat=78%"
```

## å¼¹å¹•æ ·å¼é…ç½®

### æ ·å¼ç±»å‹
```typescript
type DanmuStyle = 'beat' | 'voice' | 'complexity' | 'random' | 'manual';

const styleConfig = {
  beat: {
    baseColor: '#4ecdc4',
    highIntensityColor: '#ff6b6b',
    sizeRange: [16, 24],
    speedRange: [1, 1.5],
  },
  voice: {
    baseColor: '#54a0ff',
    highIntensityColor: '#ff9ff3',
    sizeRange: [16, 20],
    speedRange: [1, 1],
  },
  complexity: {
    baseColor: '#2ed573',
    highIntensityColor: '#ffa502',
    sizeRange: [16, 22],
    speedRange: [1, 1.3],
  },
  random: {
    baseColor: '#ffffff',
    sizeRange: [16, 16],
    speedRange: [1, 1],
  },
  manual: {
    baseColor: '#ff6b6b',
    sizeRange: [18, 18],
    speedRange: [1, 1],
  },
};
```

## å†·å´æœºåˆ¶

### å…¨å±€å†·å´
- **å†·å´æ—¶é—´**: 2ç§’ (`triggerCooldown = 2000ms`)
- **ç›®çš„**: é˜²æ­¢å¼¹å¹•è¿‡äºé¢‘ç¹

### ç‰¹å¾å˜åŒ–æ£€æµ‹
- **èŠ‚æ‹å¼ºåº¦**: å˜åŒ–é˜ˆå€¼ 0.2
- **äººå£°æ¦‚ç‡**: å˜åŒ–é˜ˆå€¼ 0.3  
- **å¤æ‚åº¦**: å˜åŒ–é˜ˆå€¼ 0.2

## ä½¿ç”¨ç¤ºä¾‹

### åœ¨å®¢æˆ·ç«¯ä¸­çš„é›†æˆ
```typescript
// åˆ›å»ºå¢å¼ºå¼¹å¹•é€‚é…å™¨
const danmuAdapter = new EnhancedDanmuAdapter();

// ç›‘å¬éŸ³é¢‘ç‰¹å¾
core.on('features', (features) => {
  // å¤„ç†å¢å¼ºå¼¹å¹•ç‰¹å¾
  danmuAdapter.handleAudioFeatures(features.rms || 0, features);
});

// ç›‘å¬å¼¹å¹•äº‹ä»¶
danmuAdapter.onDanmu((event) => {
  console.log('Generated danmu:', event);
  // æ˜¾ç¤ºå¼¹å¹•åˆ°UI
});

// å¯åŠ¨å¼¹å¹•ç”Ÿæˆ
danmuAdapter.start();
```

### æ‰‹åŠ¨è§¦å‘
```typescript
danmuAdapter.trigger({
  text: 'ğŸµ æ‰‹åŠ¨è§¦å‘å¼¹å¹•',
  style: 'manual',
  color: '#ff6b6b',
  size: 18,
});
```

## æ‰©å±•å»ºè®®

### 1. æ·»åŠ æ›´å¤šè§¦å‘æ¡ä»¶
- ä¹å™¨åˆ‡æ¢æ£€æµ‹
- é£æ ¼å˜åŒ–æ£€æµ‹
- éŸ³è‰²ç‰¹å¾å˜åŒ–

### 2. ä¸ªæ€§åŒ–å¼¹å¹•å†…å®¹
- åŸºäºç”¨æˆ·åå¥½çš„å¼¹å¹•é£æ ¼
- å¤šè¯­è¨€æ”¯æŒ
- è¡¨æƒ…ç¬¦å·åŠ¨æ€é€‰æ‹©

### 3. æ™ºèƒ½é¢‘ç‡æ§åˆ¶
- åŸºäºéŸ³ä¹å¤æ‚åº¦çš„åŠ¨æ€å†·å´
- ç”¨æˆ·äº¤äº’é¢‘ç‡è°ƒæ•´
- å†…å®¹è´¨é‡è¯„åˆ†

### 4. é«˜çº§ç‰¹å¾åˆ©ç”¨
- åˆ©ç”¨å¢å¼ºç»Ÿè®¡ç‰¹å¾
- å¤šç‰¹å¾ç»„åˆè§¦å‘
- æ—¶åºæ¨¡å¼è¯†åˆ«

---

*åŸºäºç‰¹å¾ç›®å½•å¼¹å¹•å¯ç”¨éƒ¨åˆ†çš„å»ºè®®å®ç°*
