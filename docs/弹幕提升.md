# SonoScope å¼¹å¹•ç”Ÿæˆäººæƒ…å‘³ä¸å¤šæ ·æ€§æå‡æ–¹æ¡ˆ

> ç›®æ ‡ï¼šè®©å¼¹å¹•æ›´åƒçœŸå®äººç±»ååº”ï¼Œæ›´å…·äººæƒ…å‘³ã€å¤šæ ·æ€§ï¼Œä¸éŸ³ä¹æ·±åº¦å…³è”

---

## ğŸ“Š å¼¹å¹•çš„æœ¬è´¨åˆ†æ

### å¼¹å¹•ç‰¹æ€§
- **å³æ—¶ååº”**ï¼šåŸºäºå½“å‰ç¬é—´çš„éŸ³ä¹æ„Ÿå—ï¼Œä¸éœ€è¦ä¸Šä¸‹æ–‡
- **ç‹¬ç«‹è¡¨è¾¾**ï¼šæ¯æ¡å¼¹å¹•éƒ½æ˜¯å®Œæ•´çš„æƒ³æ³•ï¼Œä¸ä¾èµ–å‰åå…³ç³»
- **æƒ…æ„ŸçœŸå®**ï¼šåƒäººç±»å¬æ­Œæ—¶çš„å³æ—¶æ„Ÿå—å’Œååº”
- **ç®€æ´ç›´æ¥**ï¼šçŸ­å°ç²¾æ‚ï¼Œè¡¨è¾¾æ ¸å¿ƒæ„Ÿå—

### å½“å‰ç³»ç»Ÿä¸è¶³
- **Personaç³»ç»Ÿè¿‡äºç®€å•**ï¼šä»…æœ‰é£æ ¼æç¤ºï¼Œç¼ºä¹æ·±åº¦äººæ ¼åŒ–
- **éŸ³ä¹ç‰¹å¾åˆ©ç”¨ä¸å……åˆ†**ï¼šç¼ºä¹å¯¹å½“å‰éŸ³ä¹ç¬é—´çš„æ·±åº¦ç†è§£
- **è¯­è¨€æ¨¡æ¿åŒ–æ˜æ˜¾**ï¼šç¼ºä¹çœŸæ­£çš„è‡ªç„¶è¡¨è¾¾å’Œæƒ…æ„ŸçœŸå®æ€§
- **é‡å¤æ€§é«˜**ï¼šå®¹æ˜“ç”Ÿæˆç›¸ä¼¼çš„è¡¨è¾¾

### å½“å‰ä¼˜åŠ¿
- å®Œå–„çš„éŸ³é¢‘ç‰¹å¾æå–ï¼ˆèŠ‚å¥ã€éŸ³è‰²ã€ç»“æ„ç­‰ï¼‰
- åŸºç¡€Personaæ¡†æ¶ï¼ˆ6ç§äººæ ¼ç±»å‹ï¼‰
- å»é‡å’Œè´¨é‡è¿‡æ»¤æœºåˆ¶
- YAMNeté«˜çº§ä¹å™¨åˆ†ç±»æ”¯æŒ

---

## ğŸ¯ æ ¸å¿ƒæå‡ç­–ç•¥

### 1. æ·±åº¦äººæ ¼åŒ–ç³»ç»Ÿ

#### 1.1 å¢å¼ºPersonaæ¶æ„
```typescript
const ENHANCED_PERSONAS = [
  {
    id: 'quiet',
    name: 'å†…å‘è†å¬è€…',
    traits: ['æ•æ„Ÿ', 'ç»†è…»', 'å†…å‘', 'è§‚å¯ŸåŠ›å¼º'],
    linguisticPatterns: {
      sentenceStructure: 'çŸ­å¥ä¸ºä¸»ï¼Œå¤šç”¨åœé¡¿è¯',
      vocabulary: ['å—¯...', 'é™é™', 'è½»è½»', 'æ…¢æ…¢', 'æ‚„æ‚„'],
      emotionalRange: 'æ¸©å’Œå†…æ•›ï¼Œè¡¨è¾¾å«è“„',
      musicSensitivity: 'å¯¹ç»†å¾®å˜åŒ–æ•æ„Ÿ'
    },
    responsePatterns: {
      toRhythm: 'ä¼šæåˆ°å¿ƒè·³ã€å‘¼å¸ç­‰èº«ä½“æ„Ÿå—',
      toTimbre: 'å…³æ³¨éŸ³è‰²çš„æƒ…æ„Ÿæ¸©åº¦',
      toDynamics: 'ç”¨å…‰å½±ã€è§¦æ„Ÿæ¯”å–»å¼ºå¼±å˜åŒ–'
    }
  },
  {
    id: 'critic',
    name: 'ä¸“ä¸šä¹è¯„äºº',
    traits: ['åˆ†æå‹', 'ä¸“ä¸š', 'ç»†è‡´', 'å®¢è§‚'],
    linguisticPatterns: {
      sentenceStructure: 'å®Œæ•´å¥å¼ï¼Œä¸“ä¸šæœ¯è¯­é€‚åº¦',
      vocabulary: ['å±‚æ¬¡', 'ç»‡ä½“', 'é…å™¨', 'æ··éŸ³', 'ç©ºé—´æ„Ÿ'],
      emotionalRange: 'ç†æ€§å®¢è§‚ï¼Œæ³¨é‡æŠ€å·§',
      musicSensitivity: 'æŠ€æœ¯å±‚é¢æ•æ„Ÿåº¦é«˜'
    },
    responsePatterns: {
      toRhythm: 'åˆ†æèŠ‚å¥å‹çš„å¤æ‚æ€§å’Œåˆ›æ–°æ€§',
      toTimbre: 'è¯„ä»·éŸ³è‰²é€‰æ‹©çš„è‰ºæœ¯æ•ˆæœ',
      toDynamics: 'å…³æ³¨åŠ¨æ€å˜åŒ–çš„éŸ³ä¹æ„ä¹‰'
    }
  },
  {
    id: 'cheer',
    name: 'çƒ­æƒ…æœ‹å‹',
    traits: ['å¤–å‘', 'çƒ­æƒ…', 'æ„Ÿæ€§', 'è¡¨è¾¾ç›´æ¥'],
    linguisticPatterns: {
      sentenceStructure: 'è¯­æ°”è¯ä¸°å¯Œï¼Œæ„Ÿå¹å¥è¾ƒå¤š',
      vocabulary: ['å“‡', 'å“ˆå“ˆ', 'è¶…', 'å¤ª', 'å¾ˆ'],
      emotionalRange: 'æƒ…æ„Ÿå¤–éœ²ï¼Œè¡¨è¾¾ç›´æ¥',
      musicSensitivity: 'å¯¹é«˜æ½®éƒ¨åˆ†ç‰¹åˆ«æ•æ„Ÿ'
    },
    responsePatterns: {
      toRhythm: 'ä¼šæåˆ°è·³èˆã€èº«ä½“å¾‹åŠ¨',
      toTimbre: 'ç”¨æ¸©æš–/æ˜äº®ç­‰ç›´è§‚æ„Ÿå—',
      toDynamics: 'æƒ…ç»ªéšéŸ³ä¹èµ·ä¼æ˜æ˜¾'
    }
  },
  {
    id: 'playful',
    name: 'åˆ›æ„ç©å®¶',
    traits: ['æƒ³è±¡åŠ›ä¸°å¯Œ', 'å¹½é»˜', 'è”æƒ³åŠ›å¼º', 'ä¸æ‹˜ä¸€æ ¼'],
    linguisticPatterns: {
      sentenceStructure: 'è·³è·ƒæ€§å¼ºï¼Œå¸¸ç”¨æ¯”å–»',
      vocabulary: ['åƒ', 'å¥½åƒ', 'ä»¿ä½›', 'æ„Ÿè§‰'],
      emotionalRange: 'æƒ…æ„Ÿä¸°å¯Œå¤šå˜ï¼Œè¡¨è¾¾ç‹¬ç‰¹',
      musicSensitivity: 'å¯¹éŸ³è‰²å’ŒèŠ‚å¥ç»„åˆæ•æ„Ÿ'
    },
    responsePatterns: {
      toRhythm: 'ä¼šè”æƒ³åˆ°æ¸¸æˆã€è¿åŠ¨ç­‰',
      toTimbre: 'ç”¨å„ç§åˆ›æ„æ¯”å–»æè¿°',
      toDynamics: 'æƒ³è±¡åŠ›ä¸°å¯Œçš„å¤¸å¼ è¡¨è¾¾'
    }
  },
  {
    id: 'steady',
    name: 'æ²‰ç¨³é™ªä¼´è€…',
    traits: ['ç¨³é‡', 'å¯é ', 'åŒ…å®¹', 'æ¸©å’Œ'],
    linguisticPatterns: {
      sentenceStructure: 'å¹³ç¨³å¥å¼ï¼Œç”¨è¯å‡†ç¡®',
      vocabulary: ['ä¸€èµ·', 'æ…¢æ…¢', 'ç¨³ç¨³', 'é™é™'],
      emotionalRange: 'æƒ…ç»ªç¨³å®šï¼Œç»™äººå®‰å…¨æ„Ÿ',
      musicSensitivity: 'å¯¹æ•´ä½“æ°›å›´å’Œèµ°å‘æ•æ„Ÿ'
    },
    responsePatterns: {
      toRhythm: 'ä¼šæåˆ°é™ªä¼´ã€å…±äº«çš„æ„Ÿå—',
      toTimbre: 'æ³¨é‡æ•´ä½“çš„å’Œè°æ„Ÿ',
      toDynamics: 'å¼ºè°ƒç¨³å®šæ€§å’ŒæŒç»­æ€§'
    }
  },
  {
    id: 'enthusiast',
    name: 'éŸ³ä¹çˆ±å¥½è€…',
    traits: ['çƒ­çˆ±', 'çœŸè¯š', 'æ„Ÿæ€§', 'è¡¨è¾¾çœŸå®'],
    linguisticPatterns: {
      sentenceStructure: 'è‡ªç„¶å£è¯­åŒ–ï¼Œå¶å°”ç”¨ç®€å•æœ¯è¯­',
      vocabulary: ['è´´é¢', 'å¹²å‡€', 'èˆ’æœ', 'å¸¦æ„Ÿ'],
      emotionalRange: 'çœŸå®è‡ªç„¶ï¼Œä¸è¿‡åˆ†ä¿®é¥°',
      musicSensitivity: 'å¯¹åˆ¶ä½œç»†èŠ‚å’Œæ•ˆæœæ•æ„Ÿ'
    },
    responsePatterns: {
      toRhythm: 'ä¼šæåˆ°å…·ä½“çš„å¬è§‰ä½“éªŒ',
      toTimbre: 'ç”¨"è´´é¢""å¹²å‡€"ç­‰ç›´è§‚æè¿°',
      toDynamics: 'å…³æ³¨åˆ¶ä½œè´¨é‡å’Œä¸ªäººæ„Ÿå—'
    }
  }
];
```

#### 1.2 åŠ¨æ€Personaé€‰æ‹©æœºåˆ¶
```typescript
function selectDynamicPersona(
  musicContext: MusicContext,
  recentPersonas: string[] = []
): string {
  const candidates: string[] = [];

  // åŸºäºéŸ³ä¹èƒ½é‡é€‰æ‹©
  if (musicContext.rhythm.energy > 0.7) {
    candidates.push('cheer', 'enthusiast');
  } else if (musicContext.rhythm.energy < 0.3) {
    candidates.push('quiet', 'steady');
  } else {
    candidates.push('playful', 'critic');
  }

  // åŸºäºéŸ³ä¹å¤æ‚åº¦é€‰æ‹©
  if (musicContext.rhythm.complexity > 0.7) {
    candidates.push('critic', 'enthusiast');
  }

  // åŸºäºæƒ…ç»ªçŠ¶æ€é€‰æ‹©
  if (musicContext.emotion.valence > 0.7) {
    candidates.push('cheer', 'playful');
  } else if (musicContext.emotion.valence < 0.3) {
    candidates.push('quiet', 'steady');
  }

  // é¿å…æœ€è¿‘é‡å¤ä½¿ç”¨
  const available = candidates.filter(id => !recentPersonas.includes(id));
  return available.length > 0 ? available[0] : candidates[0];
}
```

### 2. éŸ³ä¹ç‰¹å¾å±‚æ¬¡åŒ–åˆ†æ

#### 2.1 éŸ³ä¹ä¸Šä¸‹æ–‡ç»“æ„
```typescript
interface MusicContext {
  rhythm: {
    tempo: number;           // BPM
    stability: number;       // èŠ‚å¥ç¨³å®šæ€§ 0-1
    complexity: number;      // èŠ‚å¥å¤æ‚åº¦ 0-1
    energy: number;          // èƒ½é‡æ°´å¹³ 0-1
    regularity: number;      // è§„å¾‹æ€§ 0-1
  };
  timbre: {
    brightness: number;      // æ˜äº®åº¦ 0-1
    warmth: number;          // æ¸©æš–åº¦ 0-1
    roughness: number;       // ç²—ç³™åº¦ 0-1
    clarity: number;         // æ¸…æ™°åº¦ 0-1
    fullness: number;        // é¥±æ»¡åº¦ 0-1
  };
  structure: {
    section: 'intro' | 'verse' | 'chorus' | 'bridge' | 'outro' | 'solo';
    intensity: number;       // å¼ºåº¦ 0-1
    progression: 'building' | 'stable' | 'declining';
    duration: number;        // å½“å‰æ®µè½æŒç»­æ—¶é—´
  };
  emotion: {
    valence: number;        // æƒ…ç»ªæ­£è´Ÿ -1åˆ°1
    arousal: number;        // æ¿€å‘ç¨‹åº¦ 0-1
    tension: number;        // ç´§å¼ æ„Ÿ 0-1
    mood: 'calm' | 'energetic' | 'happy' | 'sad' | 'tense';
  };
  spectral: {
    centroid: number;        // é¢‘è°±è´¨å¿ƒ
    spread: number;          // é¢‘è°±æ‰©å±•
    flux: number;            // é¢‘è°±å˜åŒ–ç‡
    rolloff: number;        // é¢‘è°±æ»šé™ç‚¹
  };
}

function analyzeMusicContext(features: any): MusicContext {
  return {
    rhythm: {
      tempo: features.tempo || 120,
      stability: features.rhythm_regularity || 0.5,
      complexity: features.rhythm_complexity || 0.5,
      energy: features.loudness || 0.5,
      regularity: features.rhythm_regularity || 0.5
    },
    timbre: {
      brightness: features.brightness || 0.5,
      warmth: features.warmth || 0.5,
      roughness: features.roughness || 0.5,
      clarity: features.clarity || 0.5,
      fullness: features.fullness || 0.5
    },
    structure: {
      section: detectMusicSection(features),
      intensity: features.intensity || 0.5,
      progression: detectProgression(features),
      duration: features.section_duration || 0
    },
    emotion: {
      valence: features.valence || 0.5,
      arousal: features.arousal || 0.5,
      tension: features.tension || 0.5,
      mood: detectMood(features)
    },
    spectral: {
      centroid: features.spectral_centroid || 0.5,
      spread: features.spectral_spread || 0.5,
      flux: features.spectral_flux || 0.5,
      rolloff: features.spectral_rolloff || 0.5
    }
  };
}
```

#### 2.2 éŸ³ä¹æ®µè½æ£€æµ‹
```typescript
function detectMusicSection(features: any): string {
  const intensity = features.intensity || 0.5;
  const spectral_centroid = features.spectral_centroid || 0.5;
  const tempo = features.tempo || 120;

  // ç®€åŒ–çš„æ®µè½æ£€æµ‹é€»è¾‘
  if (intensity < 0.3) return 'intro';
  if (intensity > 0.8 && spectral_centroid > 0.7) return 'chorus';
  if (features.has_solo) return 'solo';
  if (features.section_change) return 'bridge';
  if (intensity > 0.5) return 'verse';
  return 'outro';
}

function detectProgression(features: any): 'building' | 'stable' | 'declining' {
  const intensity_change = features.intensity_change || 0;
  const spectral_change = features.spectral_change || 0;

  if (intensity_change > 0.1 || spectral_change > 0.1) return 'building';
  if (intensity_change < -0.1 || spectral_change < -0.1) return 'declining';
  return 'stable';
}

function detectMood(features: any): 'calm' | 'energetic' | 'happy' | 'sad' | 'tense' {
  const valence = features.valence || 0.5;
  const arousal = features.arousal || 0.5;
  const tension = features.tension || 0.5;

  if (valence > 0.6 && arousal > 0.6) return 'happy';
  if (valence < 0.4 && arousal < 0.4) return 'calm';
  if (valence < 0.4 && arousal > 0.6) return 'tense';
  if (valence < 0.4 && tension > 0.6) return 'sad';
  return 'energetic';
}
```

### 3. å³æ—¶ååº”Promptä¼˜åŒ–

#### 3.1 åŸºäºå½“å‰ç¬é—´çš„Promptç”Ÿæˆ
```typescript
function generateInstantPrompt(
  musicFeatures: any,
  persona: any,
  options: {
    needDanmu: number;
    encouragementRange: string;
  }
): string {

  const personaPrompt = persona.linguisticPatterns;

  // åŸºäºå½“å‰éŸ³ä¹ç‰¹å¾ç”Ÿæˆå³æ—¶æè¿°
  const tempoDesc = musicFeatures.tempo > 120 ? 'å¿«èŠ‚å¥' :
                   musicFeatures.tempo < 80 ? 'æ…¢èŠ‚å¥' : 'ä¸­ç­‰èŠ‚å¥';

  const energyDesc = musicFeatures.loudness > 0.7 ? 'å……æ»¡æ´»åŠ›' :
                    musicFeatures.loudness < 0.3 ? 'è½»æŸ”èˆ’ç¼“' : 'é€‚ä¸­å¹³ç¨³';

  const timbreDesc = musicFeatures.brightness > 0.6 ? 'æ˜äº®æ¸…é€' :
                    musicFeatures.warmth > 0.6 ? 'æ¸©æš–åšé‡' : 'å¹³è¡¡è‡ªç„¶';

  return `è§’è‰²ï¼š${persona.name}ï¼ˆ${persona.traits.join('ã€')}ï¼‰

å½“å‰è¿™ä¸€åˆ»çš„éŸ³ä¹ï¼š${tempoDesc}ï¼Œ${energyDesc}ï¼Œ${timbreDesc}

è¯­è¨€ç‰¹ç‚¹ï¼š${personaPrompt.sentenceStructure}ï¼Œç”¨è¯åå‘${personaPrompt.vocabulary.slice(0, 3).join('ã€')}
è¡¨è¾¾é£æ ¼ï¼š${personaPrompt.emotionalRange}ï¼Œ${personaPrompt.musicSensitivity}

éŸ³ä¹ç‰¹å¾çº¿ç´¢ï¼š
- èŠ‚å¥é€Ÿåº¦ï¼š${Math.round(musicFeatures.tempo || 120)} BPM
- èƒ½é‡æ°´å¹³ï¼š${energyDesc}
- ä¸»è¦éŸ³è‰²ï¼š${timbreDesc}
- ä¹å™¨ç‰¹å¾ï¼š${musicFeatures.dominant_instrument || 'å¤šç§ä¹å™¨'}

è¦æ±‚ï¼š
1. è¡¨è¾¾æ­¤åˆ»çš„å³æ—¶æ„Ÿå—ï¼Œå°±åƒå¬æ­Œæ—¶çªç„¶æƒ³åˆ°çš„è¯
2. ç”¨å…·ä½“çš„èº«ä½“æ„Ÿå—æˆ–ç›´è§‚æè¿°ï¼Œä¸è¦æŠ½è±¡è¯„è®º
3. å¯ä»¥æœ‰è‡ªç„¶çš„åœé¡¿è¯å’Œä¸å®Œç¾è¯­æ³•
4. æ¯æ¡éƒ½è¦æœ‰éŸ³ä¹ç›¸å…³çš„å…·ä½“é”šç‚¹è¯
5. é¿å…å¥—è·¯åŒ–çš„è¡¨è¾¾å’Œè¿‡åº¦ç…½æƒ…
6. é•¿åº¦æ§åˆ¶åœ¨6-20å­—ä¹‹é—´

è¯·ç”Ÿæˆ ${options.needDanmu} æ¡å¼¹å¹•${options.encouragementRange}ï¼Œä»¥JSONæ•°ç»„è¿”å›ã€‚`;
}
```

#### 3.2 å¤šæ ·åŒ–å“åº”æ¨¡æ¿åº“
```typescript
const RESPONSE_TEMPLATES = {
  rhythm: {
    highEnergy: [
      'è¿™èŠ‚å¥è®©æˆ‘æƒ³{action}',
      'å¿ƒè·³è·Ÿç€{instrument}èµ°',
      'å¿ä¸ä½è¦{movement}',
      '{body_part}éƒ½åœ¨è·Ÿç€åŠ¨',
      'åƒ{metaphor}ä¸€æ ·æœ‰æ´»åŠ›'
    ],
    mediumEnergy: [
      'ç¨³ç¨³çš„{feeling}',
      'è·Ÿç€{music_element}è½»è½»æ‘‡æ‘†',
      'æœ‰ç§{emotion}çš„èˆ’é€‚æ„Ÿ',
      '{time}å˜å¾—å¾ˆèˆ’æœ',
      'åƒ{experience}ä¸€æ ·è‡ªç„¶'
    ],
    lowEnergy: [
      'åƒ{metaphor}ä¸€æ ·è½»æŸ”',
      'é™é™åœ°æ„Ÿå—{feeling}',
      '{time}å˜å¾—å¾ˆæ…¢',
      'å¿ƒè·³éƒ½{emotion}äº†',
      'åƒ{experience}ä¸€æ ·å®‰é™'
    ]
  },
  timbre: {
    warm: [
      'åƒ{warm_thing}ä¸€æ ·èˆ’æœ',
      'è®©äººæƒ³{relax_action}',
      'æœ‰ç§{feeling}çš„å®‰å¿ƒæ„Ÿ',
      '{body_part}æ„Ÿè§‰{emotion}',
      'åƒ{experience}ä¸€æ ·æ¸©æš–'
    ],
    bright: [
      '{light_word}é—ªé—ªçš„',
      'åƒ{nature}ä¸€æ ·æ¸…é€',
      '{emotion}éƒ½äº®èµ·æ¥äº†',
      'æ„Ÿè§‰åƒ{light_experience}',
      '{body_part}éƒ½å˜æ˜äº®äº†'
    ],
    rough: [
      'æœ‰ç§{texture}çš„æ„Ÿè§‰',
      'åƒ{rough_thing}ä¸€æ ·æœ‰è´¨æ„Ÿ',
      '{body_part}æ„Ÿè§‰åˆ°{texture}',
      'å¬èµ·æ¥å¾ˆ{texture}',
      'åƒ{experience}ä¸€æ ·ç²—ç³™'
    ]
  },
  emotional: {
    positive: [
      '{body_part}æ„Ÿè§‰{feeling}',
      '{time}å˜å¾—{emotion}',
      'æƒ³èµ·{memory}',
      'åƒ{positive_thing}ä¸€æ ·',
      'æœ‰ç§{feeling}çš„å†²åŠ¨'
    ],
    negative: [
      '{weather}ä¸€æ ·çš„{emotion}',
      '{body_part}æœ‰ç‚¹{feeling}',
      'åƒ{experience}çš„æ„Ÿè§‰',
      'è®©äºº{emotion}èµ·æ¥',
      '{time}å˜å¾—{emotion}'
    ],
    neutral: [
      'é™é™åœ°{action}',
      'åƒ{metaphor}ä¸€æ ·{state}',
      '{time}åœ¨{action}',
      'æ„Ÿè§‰åƒ{experience}',
      '{body_part}å¾ˆ{state}'
    ]
  },
  musical: {
    instruments: [
      '{instrument}å¾ˆ{quality}',
      '{instrument}åƒ{metaphor}',
      'è¢«{instrument}å¸å¼•',
      '{instrument}åœ¨{speak}',
      '{instrument}çš„æ„Ÿè§‰å¾ˆ{feeling}'
    ],
    structure: [
      'åˆ°äº†{section}éƒ¨åˆ†',
      '{section}è®©äºº{feeling}',
      'å–œæ¬¢è¿™ä¸ª{section}',
      '{section}è½¬å¾—å¾ˆå¥½',
      '{section}å¾ˆæœ‰{quality}'
    ],
    effects: [
      '{effect}å¤„ç†å¾—{quality}',
      'è¿™ä¸ª{effect}å¾ˆ{feeling}',
      '{effect}è®©éŸ³ä¹{result}',
      '{effect}çš„æ„Ÿè§‰å¾ˆ{quality}',
      '{effect}å¤„ç†å¾—å¾ˆ{quality}'
    ]
  }
};

const TEMPLATE_VARIABLES = {
  action: ['åŠ¨èµ·æ¥', 'è·³èˆ', 'æ‘‡æ‘†', 'ç‚¹å¤´', 'æ‹æ‰‹'],
  movement: ['åŠ¨', 'è·³', 'æ‘‡', 'æ‘†', 'æ™ƒ'],
  body_part: ['å¿ƒ', 'æ‰‹', 'è„š', 'å¤´', 'èº«ä½“'],
  feeling: ['èˆ’æœ', 'å¼€å¿ƒ', 'æ¿€åŠ¨', 'æ”¾æ¾', 'ç´§å¼ '],
  emotion: ['æ¸©æš–', 'æ˜äº®', 'å®‰é™', 'æ¿€åŠ¨', 'æ”¾æ¾'],
  metaphor: ['é˜³å…‰', 'æµ·æµª', 'é£', 'é›¨', 'æ˜Ÿç©º'],
  experience: ['åœ¨å®¶', 'åœ¨æ—…è¡Œ', 'åœ¨æ¢¦ä¸­', 'åœ¨ç«¥å¹´', 'åœ¨å¤œæ™š'],
  time: ['ç°åœ¨', 'è¿™ä¸€åˆ»', 'æ­¤æ—¶', 'è¿™ä¼šå„¿', 'å½“ä¸‹'],
  music_element: ['èŠ‚æ‹', 'æ—‹å¾‹', 'å’Œå£°', 'ä½éŸ³', 'èŠ‚å¥'],
  warm_thing: ['æ¯›æ¯¯', 'é˜³å…‰', 'æ‹¥æŠ±', 'çƒ­èŒ¶', 'å£ç‚‰'],
  relax_action: ['èººä¸‹', 'é—­ä¸Šçœ¼', 'æ·±å‘¼å¸', 'æ”¾æ¾', 'ä¼‘æ¯'],
  light_word: ['äº®å…‰', 'æ˜Ÿå…‰', 'é˜³å…‰', 'é—ªå…‰', 'å…‰èŠ’'],
  nature: ['æ³‰æ°´', 'æ¸…é£', 'æ™¨å…‰', 'éœ²ç ', 'æ°´æ™¶'],
  light_experience: ['çœ‹åˆ°äº†å…‰', 'è¢«ç…§äº®', 'é—ªé—ªå‘å…‰', 'æ™¶è¹å‰”é€'],
  texture: ['ç²—ç³™', 'ç»†è…»', 'æœ‰è´¨æ„Ÿ', 'å…‰æ»‘', 'æœ‰é¢—ç²’æ„Ÿ'],
  rough_thing: ['ç ‚çº¸', 'çŸ³å¤´', 'çš®é©', 'ç²—å¸ƒ', 'æœ¨å¤´'],
  weather: ['é˜´å¤©', 'é›¨å¤©', 'é›¾å¤©', 'é£å¤©', 'é›ªå¤©'],
  positive_thing: ['é˜³å…‰', 'å½©è™¹', 'èŠ±æœµ', 'å¾®ç¬‘', 'æ‹¥æŠ±'],
  memory: ['ç«¥å¹´', 'å¤å¤©', 'æ—…è¡Œ', 'æŸä¸ªæ—¶åˆ»', 'æŸä¸ªåœ°æ–¹'],
  state: ['æ”¾æ¾', 'å®‰é™', 'èˆ’é€‚', 'è‡ªç„¶', 'å¹³é™'],
  instrument: ['å‰ä»–', 'é’¢ç´', 'é¼“', 'è´æ–¯', 'å°æç´'],
  quality: ['æ¸…æ™°', 'æ¸©æš–', 'æœ‰åŠ›', 'æŸ”å’Œ', 'æ˜äº®'],
  speak: ['è¯‰è¯´', 'æ­Œå”±', 'å“­æ³£', 'ä½è¯­', 'å‘å–Š'],
  section: ['å‰å¥', 'ä¸»æ­Œ', 'å‰¯æ­Œ', 'é—´å¥', 'ç»“å°¾'],
  effect: ['æ··å“', 'å»¶è¿Ÿ', 'å¤±çœŸ', 'åˆå”±', 'å‹ç¼©'],
  result: ['æ›´æœ‰å±‚æ¬¡', 'æ›´æ¸©æš–', 'æ›´æ¸…æ™°', 'æ›´æœ‰åŠ›', 'æ›´ä¸°å¯Œ']
};
```

### 4. åŸºäºå½“å‰ç‰¹å¾çš„å¤šæ ·åŒ–è¡¨è¾¾

#### 4.1 éŸ³ä¹ç‰¹å¾åˆ°å³æ—¶ååº”çš„æ˜ å°„
```typescript
function generateInstantReaction(
  musicFeatures: any,
  persona: any
): string[] {

  const reactions: string[] = [];

  // åŸºäºèŠ‚å¥ç‰¹å¾çš„å³æ—¶ååº”
  if (musicFeatures.tempo > 140) {
    reactions.push(
      'è¿™èŠ‚å¥å¤ªå¿«äº†ï¼',
      'å¿ƒè·³è·Ÿç€åŠ é€Ÿ',
      'å¿ä¸ä½æƒ³åŠ¨èµ·æ¥',
      'å¤ªå¸¦æ„Ÿäº†è¿™ä¸ªèŠ‚å¥',
      'èƒ½é‡æ»¡æ»¡çš„æ„Ÿè§‰'
    );
  } else if (musicFeatures.tempo < 70) {
    reactions.push(
      'æ…¢å¾—å¾ˆèˆ’æœ',
      'æ—¶é—´éƒ½æ…¢ä¸‹æ¥äº†',
      'å¾ˆå®‰é™çš„æ„Ÿè§‰',
      'åƒåœ¨æ…¢æ…¢å“èŒ¶',
      'å¿ƒéƒ½é™ä¸‹æ¥äº†'
    );
  }

  // åŸºäºéŸ³è‰²ç‰¹å¾çš„å³æ—¶ååº”
  if (musicFeatures.brightness > 0.8) {
    reactions.push(
      'éŸ³è‰²å¥½äº®',
      'é—ªé—ªå‘å…‰çš„æ„Ÿè§‰',
      'åƒæ°´æ™¶ä¸€æ ·æ¸…é€',
      'å¾ˆæ¸…æ¾ˆçš„éŸ³è‰²',
      'å¬ç€å¾ˆæ¸…çˆ½'
    );
  } else if (musicFeatures.warmth > 0.7) {
    reactions.push(
      'æ¸©æš–çš„éŸ³è‰²',
      'åƒæ¯›æ¯¯ä¸€æ ·èˆ’æœ',
      'å¾ˆæœ‰å®‰å…¨æ„Ÿ',
      'å¬ç€å¾ˆå®‰å¿ƒ',
      'æš–æ´‹æ´‹çš„æ„Ÿè§‰'
    );
  }

  // åŸºäºä¹å™¨ç‰¹å¾çš„å³æ—¶ååº”
  const instrumentReactions = {
    'piano': ['é’¢ç´å£°å¥½ç¾', 'ç´é”®æ•²åœ¨å¿ƒä¸Š', 'é’¢ç´å¾ˆæ¸©æŸ”'],
    'guitar': ['å‰ä»–å£°å¾ˆåŠ¨äºº', 'å¼¦éŸ³å¾ˆæœ‰æ•…äº‹', 'å‰ä»–å£°å¾ˆæ¸©æš–'],
    'drums': ['é¼“ç‚¹å¾ˆæœ‰åŠ›', 'èŠ‚å¥è¢«å¸¦åŠ¨äº†', 'é¼“å£°å¾ˆå¸¦æ„Ÿ'],
    'bass': ['ä½éŸ³å¾ˆèˆ’æœ', 'è´æ–¯åœ¨éœ‡åŠ¨', 'ä½é¢‘å¾ˆæœ‰æ„Ÿè§‰'],
    'violin': ['å°æç´å¥½ç¾', 'å¼¦éŸ³å¾ˆåŠ¨äºº', 'ç´å£°å¾ˆä¼˜é›…'],
    'vocals': ['äººå£°å¾ˆè´´é¢', 'å£°éŸ³å¾ˆæœ‰æ„Ÿæƒ…', 'å”±å¾—å¾ˆæŠ•å…¥']
  };

  const dominantInstrument = musicFeatures.dominant_instrument;
  if (dominantInstrument && instrumentReactions[dominantInstrument]) {
    reactions.push(...instrumentReactions[dominantInstrument]);
  }

  // åŸºäºèƒ½é‡çš„å³æ—¶ååº”
  if (musicFeatures.loudness > 0.8) {
    reactions.push(
      'å¤ªæœ‰åŠ›é‡äº†',
      'èƒ½é‡çˆ†å‘',
      'è¢«éœ‡æ’¼åˆ°äº†',
      'å¾ˆæœ‰å†²å‡»åŠ›',
      'æ°”åŠ¿å¾ˆè¶³'
    );
  } else if (musicFeatures.loudness < 0.3) {
    reactions.push(
      'å¾ˆè½»æŸ”',
      'å°å¿ƒç¿¼ç¿¼çš„æ„Ÿè§‰',
      'å¾ˆæ¸©æŸ”çš„ç¬é—´',
      'è½»å£°ç»†è¯­çš„',
      'å¾ˆå®‰é™çš„æ—¶å…‰'
    );
  }

  return reactions;
}
```

#### 4.2 PersonaåŒ–çš„å³æ—¶è¡¨è¾¾
```typescript
function getPersonaInstantReactions(personaId: string, musicFeatures: any): string[] {
  const baseReactions = generateInstantReaction(musicFeatures, null);

  const personaFilters = {
    quiet: (reactions: string[]) =>
      reactions.filter(r =>
        !r.includes('å¤ª') && !r.includes('å¾ˆ') && !r.includes('çˆ†å‘')
      ).map(r =>
        r.replace('ï¼', 'ã€‚').replace('å¾ˆ', 'æœ‰ç‚¹')
      ),
    cheer: (reactions: string[]) =>
      reactions.map(r => r + '!').filter(r => r.length < 15),
    critic: (reactions: string[]) =>
      reactions.filter(r =>
        r.includes('éŸ³è‰²') || r.includes('èŠ‚å¥') || r.includes('ä¹å™¨')
      ),
    playful: (reactions: string[]) =>
      reactions.map(r => {
        const playfulWords = ['å¥½åƒ', 'ä»¿ä½›', 'æ„Ÿè§‰åƒ', 'æœ‰ç‚¹åƒ'];
        const randomWord = playfulWords[Math.floor(Math.random() * playfulWords.length)];
        return r.replace(/å¾ˆ/, randomWord);
      }),
    steady: (reactions: string[]) =>
      reactions.filter(r =>
        r.length < 12 && r.includes('å¾ˆ')
      ),
    enthusiast: (reactions: string[]) =>
      reactions.filter(r =>
        r.includes('æ„Ÿè§‰') || r.includes('å¾ˆ') || r.includes('å¥½')
      )
  };

  const filter = personaFilters[personaId] || ((r: string[]) => r);
  return filter(baseReactions);
}
```

### 5. å®æ–½ä¼˜å…ˆçº§å’Œæ—¶é—´è§„åˆ’

#### 5.1 Phase 1: Personaç³»ç»Ÿå‡çº§ï¼ˆ1-2å‘¨ï¼‰
**ç›®æ ‡ï¼šæ·±åº¦äººæ ¼åŒ–å’Œå³æ—¶ååº”ä¼˜åŒ–**

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] æ‰©å±•Personaç³»ç»Ÿï¼Œå¢åŠ è¯¦ç»†çš„è¯­è¨€æ¨¡å¼
- [ ] å»ºç«‹éŸ³ä¹ç‰¹å¾åˆ°å³æ—¶ååº”çš„æ˜ å°„
- [ ] ä¼˜åŒ–Promptç”Ÿæˆï¼Œèšç„¦å½“å‰ç¬é—´
- [ ] æ·»åŠ å¤šæ ·åŒ–è¡¨è¾¾æ¨¡æ¿åº“
- [ ] å®Œå–„APIå‚æ•°æ”¯æŒ

**é¢„æœŸæˆæœï¼š**
- Personaä¸°å¯Œåº¦æå‡200%
- å³æ—¶ååº”å‡†ç¡®åº¦æå‡60%
- è¯­è¨€è‡ªç„¶åº¦æå‡40%

#### 5.2 Phase 2: éŸ³ä¹ç‰¹å¾æ·±åº¦åˆ©ç”¨ï¼ˆ2-3å‘¨ï¼‰
**ç›®æ ‡ï¼šå¼ºåŒ–éŸ³ä¹ç‰¹å¾åˆ†æå’Œè¡¨è¾¾**

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] å®Œå–„éŸ³ä¹ç‰¹å¾åˆ°è¯æ±‡çš„æ˜ å°„
- [ ] åŸºäºä¹å™¨ã€èŠ‚å¥ã€éŸ³è‰²çš„ååº”åº“
- [ ] PersonaåŒ–çš„è¡¨è¾¾è¿‡æ»¤å™¨
- [ ] ä¼˜åŒ–éŸ³ä¹é”šç‚¹è¯çš„ä½¿ç”¨
- [ ] å¢å¼ºéŸ³ä¹å…³è”æ€§æ£€æµ‹

**é¢„æœŸæˆæœï¼š**
- éŸ³ä¹å…³è”æ€§æå‡80%
- è¯æ±‡ä¸°å¯Œåº¦æå‡60%
- äººæ ¼è¯†åˆ«å‡†ç¡®ç‡è¾¾åˆ°85%

#### 5.3 Phase 3: è´¨é‡ä¼˜åŒ–å’Œéƒ¨ç½²ï¼ˆ1-2å‘¨ï¼‰
**ç›®æ ‡ï¼šè´¨é‡æå‡å’Œæ€§èƒ½ä¼˜åŒ–**

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] å®ç°è´¨é‡è¯„åˆ†ç³»ç»Ÿ
- [ ] æ€§èƒ½ä¼˜åŒ–å’Œå“åº”æ—¶é—´æ§åˆ¶
- [ ] A/Bæµ‹è¯•æ¡†æ¶
- [ ] ç”¨æˆ·åé¦ˆæ”¶é›†å’Œè°ƒä¼˜
- [ ] æ–‡æ¡£å®Œå–„

**é¢„æœŸæˆæœï¼š**
- ç³»ç»Ÿå“åº”æ—¶é—´<100ms
- ç”¨æˆ·æ»¡æ„åº¦æå‡50%
- è´¨é‡åˆæ ¼ç‡>90%

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœæŒ‡æ ‡

### äººæƒ…å‘³æŒ‡æ ‡
- **è‡ªç„¶åº¦è¯„åˆ†**ï¼šä»3.2â†’4.5ï¼ˆ5åˆ†åˆ¶ï¼‰
- **äººæ ¼è¯†åˆ«å‡†ç¡®ç‡**ï¼š85%+
- **æƒ…æ„Ÿè¡¨è¾¾çœŸå®æ€§**ï¼š90%+
- **è¯­è¨€è‡ªç„¶åº¦**ï¼šä»40%â†’85%

### å¤šæ ·æ€§æŒ‡æ ‡
- **å¥å¼é‡å¤ç‡**ï¼šä»30%â†’<10%
- **è¯æ±‡ä¸°å¯Œåº¦**ï¼šæå‡60%
- **è¡¨è¾¾æ–¹å¼å¤šæ ·æ€§**ï¼šæå‡70%
- **PersonaåŒºåˆ†åº¦**ï¼š85%+

### éŸ³ä¹å…³è”æ€§æŒ‡æ ‡
- **éŸ³ä¹æ•æ„Ÿåº¦**ï¼šä»40%â†’85%
- **éŸ³ä¹é”šç‚¹å‡†ç¡®ç‡**ï¼š85%+
- **å³æ—¶ååº”å‡†ç¡®ç‡**ï¼š80%+
- **ä¹å™¨è¯†åˆ«å‡†ç¡®ç‡**ï¼š75%+

### ç”¨æˆ·ä½“éªŒæŒ‡æ ‡
- **ç”¨æˆ·å‚ä¸åº¦**ï¼šæå‡40%
- **å¼¹å¹•äº’åŠ¨é¢‘ç‡**ï¼šå¢åŠ 50%
- **æ»¡æ„åº¦è¯„åˆ†**ï¼šä»3.5â†’4.5
- **çœŸå®æ„Ÿè¯„åˆ†**ï¼šä»3.0â†’4.2

---

## ğŸ’¡ å¿«é€Ÿæ”¹è¿›å»ºè®®

### ç«‹å³å¯å®æ–½çš„æ”¹è¿›ï¼ˆ1-2å¤©ï¼‰
1. **æ‰©å±•Personaæè¿°**ï¼šä¸ºæ¯ä¸ªpersonaæ·»åŠ è¯¦ç»†çš„æ€§æ ¼ç‰¹å¾å’Œè¯­è¨€é£æ ¼
2. **éŸ³ä¹ç‰¹å¾æ˜ å°„**ï¼šå»ºç«‹éŸ³ä¹ç‰¹å¾ï¼ˆèŠ‚å¥ã€éŸ³è‰²ã€ä¹å™¨ï¼‰åˆ°å³æ—¶ååº”çš„æ˜ å°„
3. **å³æ—¶ååº”æ¨¡æ¿**ï¼šæ·»åŠ æ›´å¤šåŸºäºå½“å‰ç¬é—´çš„è¡¨è¾¾æ¨¡æ¿
4. **ç®€åŒ–Prompt**ï¼šèšç„¦å½“å‰éŸ³ä¹ç¬é—´ï¼Œç§»é™¤å¤æ‚ä¸Šä¸‹æ–‡

### çŸ­æœŸæ”¹è¿›ï¼ˆ1å‘¨å†…ï¼‰
1. **ä¹å™¨è¯†åˆ«å¢å¼º**ï¼šåŸºäºYAMNetæ”¹å–„ä¹å™¨è¯†åˆ«çš„å³æ—¶ååº”
2. **åŠ¨æ€Personaé€‰æ‹©**ï¼šåŸºäºéŸ³ä¹ç‰¹å¾é€‰æ‹©é€‚åˆçš„persona
3. **è¡¨è¾¾å¤šæ ·æ€§**ï¼šå»ºç«‹ä¸åŒè§’åº¦çš„å³æ—¶ååº”åº“
4. **è´¨é‡è¯„åˆ†**ï¼šæ·»åŠ éŸ³ä¹å…³è”æ€§å’Œè‡ªç„¶åº¦è¯„åˆ†

### ä¸­æœŸæ”¹è¿›ï¼ˆ2-4å‘¨ï¼‰
1. **æ·±åº¦ç‰¹å¾åˆ©ç”¨**ï¼šå®Œå–„éŸ³ä¹ç‰¹å¾çš„è¡¨è¾¾æ˜ å°„
2. **ä¸ªæ€§åŒ–é€‚é…**ï¼šåŸºäºç”¨æˆ·åå¥½è°ƒæ•´personaæƒé‡
3. **éŸ³ä¹é”šç‚¹ä¼˜åŒ–**ï¼šæå‡éŸ³ä¹ç›¸å…³è¯æ±‡çš„å‡†ç¡®æ€§
4. **A/Bæµ‹è¯•**ï¼šå»ºç«‹æ•ˆæœè¯„ä¼°å’Œä¼˜åŒ–æœºåˆ¶

---

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### å…³é”®ä»£ç ä¿®æ”¹ä½ç½®
1. **Personaç³»ç»Ÿ**ï¼š`route.ts:74-88` æ‰©å±•PERSONASå®šä¹‰
2. **éŸ³ä¹åˆ†æ**ï¼šåœ¨featureså¤„ç†åæ·»åŠ éŸ³ä¹ä¸Šä¸‹æ–‡åˆ†æ
3. **Promptç”Ÿæˆ**ï¼š`route.ts:96-112` é‡æ„promptç”Ÿæˆé€»è¾‘
4. **å»é‡è¿‡æ»¤**ï¼š`route.ts:222-302` æ·»åŠ éŸ³ä¹æ„ŸçŸ¥çš„è¿‡æ»¤é€»è¾‘

### å‘åå…¼å®¹æ€§
- ä¿æŒç°æœ‰APIæ¥å£ä¸å˜
- æ–°å‚æ•°ä½¿ç”¨é»˜è®¤å€¼
- æ¸è¿›å¼å¯ç”¨æ–°åŠŸèƒ½
- æ”¯æŒå›é€€æœºåˆ¶

### æ€§èƒ½è€ƒè™‘
- éŸ³ä¹åˆ†æå»¶è¿Ÿ<50ms
- Personaé€‰æ‹©<10ms
- å“åº”ç”Ÿæˆ<100ms
- å†…å­˜ä½¿ç”¨<100MB

---

**æ€»ç»“ï¼š** é€šè¿‡æ·±åº¦äººæ ¼åŒ–ã€éŸ³ä¹ä¸Šä¸‹æ–‡æ„ŸçŸ¥å’Œè‡ªç„¶è¯­è¨€ç”Ÿæˆä¼˜åŒ–ï¼Œå¯ä»¥å°†å¼¹å¹•ç³»ç»Ÿä»AIå¼è¯„è®ºæå‡ä¸ºçœŸæ­£çš„äººç±»ååº”ï¼Œæ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒå’ŒéŸ³ä¹å…±é¸£æ„Ÿã€‚å»ºè®®æŒ‰ç…§Phaseé¡ºåºé€æ­¥å®æ–½ï¼Œç¡®ä¿æ¯ä¸ªé˜¶æ®µéƒ½æœ‰å¯éªŒè¯çš„æ”¹è¿›æ•ˆæœã€‚