## SonoScope 核心特征清单（Feature Catalog）

说明：本清单汇总当前分析管线输出/可导出的核心特征字段，覆盖基础声学特征、窗口聚合统计、模型输出与增强统计，便于测试校验、前端展示与 LLM 提示使用。字段命名遵循代码中约定（优先使用英文 key，中文仅用于说明）。

### 数据来源与缩写
- Meyda: 基础音频特征（功率、频谱、色度、MFCC 等）
- HPSS: 谐波-打击分离（percussive/harmonic 比率与派生）
- CREPE: 音高检测（pitch）
- aubio: 节拍/速度（tempo/BPM/拍号）
- OpenL3: 音色嵌入与统计（timbre）
- YAMNet/musicnn: 预训练乐器/风格标签与概率（instrumentProbabilities 等）

### 约定
- mean/variance: 指 2–4s 窗口统计的均值/方差（FeatureWindow.features.*）
- Stats: 指增强统计对象中的字段（EnhancedFeatureWindow.*Stats）
- 单位：未标注默认为无量纲；BPM 为每分钟拍数；LKFS 为响度单位

---

### 基础与聚合（FeatureWindow.features）

| Key | Type | Source | 说明 |
| --- | --- | --- | --- |
| rms_mean | number | Meyda | 均方根能量均值 |
| rms_variance | number | Meyda | 均方根能量方差 |
| rms_peak | number | Meyda | 峰值能量 |
| zcr_mean | number | Meyda | 过零率均值 |
| zcr_variance | number | Meyda | 过零率方差 |
| spectralCentroid_mean | number | Meyda | 频谱质心均值 |
| spectralCentroid_variance | number | Meyda | 频谱质心方差 |
| spectralBandwidth_mean | number | Meyda | 频谱带宽均值 |
| spectralBandwidth_variance | number | Meyda | 频谱带宽方差 |
| spectralRolloff_mean | number | Meyda | 频谱滚降均值 |
| spectralRolloff_variance | number | Meyda | 频谱滚降方差 |
| spectralFlatness_mean | number | Meyda | 频谱平坦度均值 |
| spectralFlatness_variance | number | Meyda | 频谱平坦度方差 |
| spectralFlux_mean | number | Meyda | 频谱流均值 |
| spectralFlux_variance | number | Meyda | 频谱流方差 |
| spectralSpread_mean | number | Meyda | 频谱扩散均值 |
| spectralSpread_variance | number | Meyda | 频谱扩散方差 |
| spectralSkewness_mean | number | Meyda | 频谱偏度均值 |
| spectralSkewness_variance | number | Meyda | 频谱偏度方差 |
| spectralKurtosis_mean | number | Meyda | 频谱峰度均值 |
| spectralKurtosis_variance | number | Meyda | 频谱峰度方差 |
| loudness_mean | number | Meyda | 响度均值（相对） |
| loudness_variance | number | Meyda | 响度方差（相对） |
| perceptualSpread_mean | number | Meyda | 感知扩散均值 |
| perceptualSpread_variance | number | Meyda | 感知扩散方差 |
| perceptualSharpness_mean | number | Meyda | 感知锐度均值 |
| perceptualSharpness_variance | number | Meyda | 感知锐度方差 |
| dynamic_range | number | Meyda | 动态范围（窗口内） |
| loudness_lkfs | number | Meyda | LKFS 标准响度（窗口） |
| tempo_bpm | number | aubio | 估计 BPM |
| beat_strength | number | aubio | 节拍强度 |
| voiceProb_mean | number | Meyda/模型融合 | 人声概率均值 |
| voiceProb_variance | number | Meyda/模型融合 | 人声概率方差 |
| percussiveRatio_mean | number | HPSS | 打击成分比例均值 |
| percussiveRatio_variance | number | HPSS | 打击成分比例方差 |
| harmonicRatio_mean | number | HPSS | 谐波成分比例均值 |
| harmonicRatio_variance | number | HPSS | 谐波成分比例方差 |
| instrumentConfidence_mean | number | YAMNet/musicnn | 乐器识别置信度均值 |
| instrumentConfidence_variance | number | YAMNet/musicnn | 乐器识别置信度方差 |
| instrumentConfidence | number | YAMNet/musicnn | 窗口聚合乐器置信度 |
| dominantInstrument | string | YAMNet/musicnn | 主导乐器标签（规范英文） |
| instrumentHistogram | Record<string,number> | YAMNet/musicnn | 乐器标签直方图 |

#### Chroma（12维 × 2）
| Key | Type | Source | 说明 |
| --- | --- | --- | --- |
| chroma_mean[0..11] | number | Meyda | 色度 12 维均值 |
| chroma_variance[0..11] | number | Meyda | 色度 12 维方差 |

#### Spectral Contrast（6维 × 2）
| Key | Type | Source | 说明 |
| --- | --- | --- | --- |
| spectralContrast_mean[0..5] | number | Meyda | 频谱对比度 6 维均值 |
| spectralContrast_variance[0..5] | number | Meyda | 频谱对比度 6 维方差 |

#### MFCC（13维 × 2）
| Key | Type | Source | 说明 |
| --- | --- | --- | --- |
| mfcc_mean[0..12] | number | Meyda | MFCC 13 维均值 |
| mfcc_variance[0..12] | number | Meyda | MFCC 13 维方差 |

> 小计（基础+聚合）：
- 标量（不含数组）：约 32 项
- Chroma 24 项 + Spectral Contrast 12 项 + MFCC 26 项 ≈ 62 项
- 合计 ≥ 94 项

---

### 增强统计（EnhancedFeatureWindow.*Stats）

#### pitchStats（CREPE）
| Key | Type | 说明 |
| --- | --- | --- |
| pitchStats.avgFundamentalFreq | number | 平均基频（Hz） |
| pitchStats.pitchStability | number | 音高稳定度（0-1） |
| pitchStats.pitchRange | number | 音高范围（半音/Hz，实现依赖） |
| pitchStats.dominantPitch | string | 主导音高类别（如 A4） |
| pitchStats.pitchConfidence | number | 音高置信度（0-1） |

#### tempoStats（aubio）
| Key | Type | 说明 |
| --- | --- | --- |
| tempoStats.avgBpm | number | 平均 BPM |
| tempoStats.tempoStability | number | 速度稳定度（0-1） |
| tempoStats.tempoRange | number | 速度范围（BPM） |
| tempoStats.dominantTimeSignature | string | 主导拍号（如 4/4） |
| tempoStats.tempoConfidence | number | 速度置信度（0-1） |

#### timbreStats（OpenL3）
| Key | Type | 说明 |
| --- | --- | --- |
| timbreStats.avgBrightness | number | 亮度均值（0-1） |
| timbreStats.avgWarmth | number | 温暖度均值（0-1） |
| timbreStats.avgRoughness | number | 粗糙度均值（0-1） |
| timbreStats.dominantTimbre | string | 主导音色类别 |
| timbreStats.timbreConfidence | number | 音色置信度（0-1） |

#### instrumentStats（YAMNet/musicnn）
| Key | Type | 说明 |
| --- | --- | --- |
| instrumentStats.dominantInstrument | string | 主导乐器（规范英文） |
| instrumentStats.instrumentCount | number | 乐器种类数估计 |
| instrumentStats.polyphony | number | 复音度估计 |
| instrumentStats.instrumentDiversity | number | 乐器多样性（0-1） |
| instrumentStats.instrumentConfidence | number | 乐器置信度（0-1） |

#### enhancedHPSSStats（HPSS 衍生）
| Key | Type | 说明 |
| --- | --- | --- |
| enhancedHPSSStats.avgMusicalComplexity | number | 音乐复杂度（0-1） |
| enhancedHPSSStats.avgMusicalStability | number | 音乐稳定度（0-1） |
| enhancedHPSSStats.avgMusicalRichness | number | 音乐丰富度（0-1） |
| enhancedHPSSStats.avgSeparationQuality | number | 分离质量（0-1） |
| enhancedHPSSStats.enhancedFeatureCount | number | 增强特征计数 |

> 小计（增强）：5+5+5+5+5 = 25 项；与上节合计：≥ 119 项

---

### HPSS 细化特征（FeatureFrame.hpssFeatures）

#### harmonicFeatures
| Key | Type | 说明 |
| --- | --- | --- |
| hpssFeatures.harmonicFeatures.spectralCentroid | number | 谐波频谱质心 |
| hpssFeatures.harmonicFeatures.spectralBandwidth | number | 谐波频谱带宽 |
| hpssFeatures.harmonicFeatures.spectralRolloff | number | 谐波频谱滚降 |
| hpssFeatures.harmonicFeatures.harmonicEnergy | number | 谐波能量 |
| hpssFeatures.harmonicFeatures.harmonicComplexity | number | 谐波复杂度 |
| hpssFeatures.harmonicFeatures.pitchStrength | number | 音高强度 |
| hpssFeatures.harmonicFeatures.tonalCentroid | number | 音调质心 |

#### percussiveFeatures
| Key | Type | 说明 |
| --- | --- | --- |
| hpssFeatures.percussiveFeatures.percussiveEnergy | number | 打击乐能量 |
| hpssFeatures.percussiveFeatures.attackStrength | number | 攻击强度 |
| hpssFeatures.percussiveFeatures.rhythmRegularity | number | 节奏规律性 |
| hpssFeatures.percussiveFeatures.percussiveComplexity | number | 打击乐复杂度 |
| hpssFeatures.percussiveFeatures.transientDensity | number | 瞬态密度 |
| hpssFeatures.percussiveFeatures.beatStrength | number | 节拍强度 |

#### separationFeatures
| Key | Type | 说明 |
| --- | --- | --- |
| hpssFeatures.separationFeatures.harmonicRatio | number | 谐波占比 |
| hpssFeatures.separationFeatures.percussiveRatio | number | 打击占比 |
| hpssFeatures.separationFeatures.separationQuality | number | 分离质量 |
| hpssFeatures.separationFeatures.energyPreservation | number | 能量保持度 |
| hpssFeatures.separationFeatures.harmonicPercussiveRatio | number | 谐波/打击比 |

#### combinedFeatures
| Key | Type | 说明 |
| --- | --- | --- |
| hpssFeatures.combinedFeatures.musicStyle | string | 音乐风格预测（标签） |
| hpssFeatures.combinedFeatures.instrumentType | string | 乐器类型预测（标签） |
| hpssFeatures.combinedFeatures.complexity | number | 整体复杂度 |
| hpssFeatures.combinedFeatures.energy | number | 整体能量 |
| hpssFeatures.combinedFeatures.dynamics | number | 动态范围 |

---

### 模型输出与概率（FeatureFrame）
| Key | Type | Source | 说明 |
| --- | --- | --- | --- |
| instrumentProbabilities | Record<string,number> | YAMNet/musicnn | 各乐器/标签概率分布（Top-K） |
| dominantInstrument | string | YAMNet/musicnn | 主导乐器（重复列于聚合处） |
| instrumentConfidence | number | YAMNet/musicnn | 主导乐器置信度（重复列于聚合处） |

---

### 建议的 Core JSON（对外稳定接口，便于测试/LLM）
为保证可验证与跨语言一致性，建议在对外响应中附带如下结构（不替代上面原有字段）：

```json
{
  "style": { "label": "techno", "confidence": 0.85 },
  "instruments": {
    "primary": "drums",
    "secondary": "synth",
    "probabilities": { "drums": 0.8, "piano": 0.1, "guitar": 0.05 },
    "confidence": 0.8
  },
  "tempo": { "bpm": 128, "beatStrength": 0.76 },
  "voice": { "probability": 0.12 },
  "hpss": { "percussiveRatio": 0.35, "harmonicRatio": 0.65 },
  "timbre": { "warmth": 0.58, "brightness": 0.42, "roughness": 0.21 }
}
```

同时附加一行英文 token 摘要（Summary tokens）便于日志与测试断言：
```
style=techno; instrument=drums; bpm=128; voiceProb=0.12; percRatio=0.35
```

---

### 版本与维护
- 本清单与代码中接口一致性以 `app/lib/feature-aggregator.ts`、`app/lib/enhanced-feature-aggregator.ts`、`app/lib/hpss-feature-extractor.ts` 为准。
- 如需扩展/收缩字段，请同步更新本文档与测试断言，确保可追踪性与可验证性。
