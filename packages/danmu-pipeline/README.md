# å¼¹å¹•ç®¡çº¿ (Danmu Pipeline)

åŸºäºéŸ³é¢‘ç‰¹å¾çš„æ™ºèƒ½å¼¹å¹•ç”Ÿæˆç³»ç»Ÿï¼Œæ”¯æŒè‡ªåŠ¨è§¦å‘ã€æµå¼ç”Ÿæˆã€è‡ªé€‚åº”è°ƒåº¦ã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
packages/danmu-pipeline/
â”œâ”€â”€ README.md                 # æœ¬æ–‡æ¡£
â”œâ”€â”€ danmu-engine.ts          # å¼¹å¹•æ¸²æŸ“å¼•æ“
â”œâ”€â”€ danmu-pipeline.ts        # å¼¹å¹•ç®¡çº¿æ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ danmu-scheduler.ts       # æ™ºèƒ½è°ƒåº¦å™¨
â”œâ”€â”€ stream-client.ts         # NDJSON æµå¼å®¢æˆ·ç«¯
â”œâ”€â”€ event-bus.ts            # äº‹ä»¶æ€»çº¿
â”œâ”€â”€ useDanmuPipeline.ts     # React Hook
â””â”€â”€ api-route.ts            # Edge API è·¯ç”±ç¤ºä¾‹
```

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1. å¼¹å¹•å¼•æ“ (`danmu-engine.ts`)
- **æ°´å¹³è½¨é“ç³»ç»Ÿ**: 8æ¡å›ºå®šè½¨é“ï¼Œå¼¹å¹•ä¸ä¸Šä¸‹é£˜ç§»
- **é€Ÿåº¦å˜åŒ–**: åŸºäºéŸ³é¢‘å¼ºåº¦è°ƒåˆ¶ï¼Œæ¯æ¡å¼¹å¹•é€Ÿåº¦ä¸åŒ
- **å®Œæ•´ç©¿å±**: å¼¹å¹•å®Œå…¨èµ°å‡ºå±å¹•åæ‰æ¶ˆå¤±
- **å¤–éƒ¨æ³¨å…¥**: æ”¯æŒ `ingestText(text)` æ–¹æ³•

### 2. æ™ºèƒ½è°ƒåº¦å™¨ (`danmu-scheduler.ts`)
- **é©±åŠ¨è®¡ç®—**: `drive = 0.5*loud + 0.3*tempo + 0.2*beat`
- **è‡ªé€‚åº”é—´éš”**: 3-10ç§’åŸºç¡€æŠ–åŠ¨ï¼Œæ ¹æ®é©±åŠ¨å€¼è°ƒæ•´
- **å¹¶å‘æ§åˆ¶**: 1-3æ¡åŒæ—¶ç”Ÿæˆï¼Œé«˜é©±åŠ¨æ—¶å¹¶å‘å¢åŠ 
- **è¿Ÿæ»æœºåˆ¶**: é¿å…é¢‘ç¹åˆ‡æ¢ï¼Œå‡æ¡£400msï¼Œé™æ¡£800ms

### 3. å¼¹å¹•ç®¡çº¿ (`danmu-pipeline.ts`)
- **è‡ªåŠ¨è§¦å‘**: åŸºäºRMSé˜ˆå€¼è‡ªåŠ¨ç”Ÿæˆå¼¹å¹•
- **æµå¼å¤„ç†**: è°ƒç”¨Edge APIè·å–å¤šæ¡è¯„è®º
- **çŠ¶æ€ç®¡ç†**: è·Ÿè¸ªé£æ ¼ã€å¹¶å‘æ•°ã€ç”ŸæˆçŠ¶æ€
- **é”™è¯¯å¤„ç†**: ç½‘ç»œå¤±è´¥æ—¶ä¼˜é›…é™çº§

### 4. æµå¼å®¢æˆ·ç«¯ (`stream-client.ts`)
- **NDJSONè§£æ**: å®æ—¶è§£ææœåŠ¡ç«¯æµå¼å“åº”
- **äº‹ä»¶å›è°ƒ**: `onStyle`ã€`onComment`ã€`onDone`ã€`onError`
- **é”™è¯¯æ¢å¤**: ç½‘ç»œä¸­æ–­æ—¶è‡ªåŠ¨é‡è¯•

### 5. React Hook (`useDanmuPipeline.ts`)
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: è‡ªåŠ¨åˆå§‹åŒ–å’Œæ¸…ç†
- **çŠ¶æ€æš´éœ²**: æ´»è·ƒçŠ¶æ€ã€å½“å‰é£æ ¼ã€å¼¹å¹•æ•°é‡
- **æ§åˆ¶æ¥å£**: `start()`ã€`stop()`ã€`trigger()`ã€`handleAudioFeatures()`

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### åŸºç¡€é›†æˆ

```tsx
import { useDanmuPipeline } from './useDanmuPipeline';

function App() {
  const danmuPipeline = useDanmuPipeline({
    enabled: true,
    autoStart: false,
    needComments: 4,
    locale: 'zh-CN',
    rmsThreshold: 0.05,
    maxConcurrency: 2,
  });

  // å¯åŠ¨
  const handleStart = () => {
    danmuPipeline.start();
  };

  // å¤„ç†éŸ³é¢‘ç‰¹å¾
  const handleAudioFeatures = (rms: number, features?: Record<string, unknown>) => {
    danmuPipeline.handleAudioFeatures(rms, features);
  };

  return (
    <div>
      <button onClick={handleStart}>å¼€å§‹å¼¹å¹•</button>
      <div>çŠ¶æ€: {danmuPipeline.isActive ? 'æ´»è·ƒ' : 'åœæ­¢'}</div>
      <div>é£æ ¼: {danmuPipeline.currentStyle}</div>
      <div>å¼¹å¹•æ•°: {danmuPipeline.danmuCount}</div>
    </div>
  );
}
```

### æœåŠ¡ç«¯API

å°† `api-route.ts` éƒ¨ç½²åˆ° Next.js App Router:

```typescript
// app/api/analyze/route.ts
export const runtime = 'edge';

export async function POST(req: Request) {
  // è¿”å›NDJSONæµå¼å“åº”
  // {"type":"style","style":"Electronic","confidence":0.82}
  // {"type":"comment","idx":0,"text":"é¼“ç‚¹ç¨³ï¼Œä½é¢‘æ¨è¿›å¾—å¾ˆèˆ’æœã€‚"}
  // {"type":"done"}
}
```

## âš™ï¸ é…ç½®é€‰é¡¹

### PipelineConfig
```typescript
interface PipelineConfig {
  apiPath?: string;           // APIè·¯å¾„ï¼Œé»˜è®¤ '/api/analyze'
  needComments?: number;      // æ¯æ¬¡ç”Ÿæˆè¯„è®ºæ•°ï¼Œé»˜è®¤ 4
  locale?: string;           // è¯­è¨€ï¼Œé»˜è®¤ 'zh-CN'
  minIntervalMs?: number;    // æœ€å°é—´éš”ï¼Œé»˜è®¤ 2000ms
  maxConcurrency?: number;   // æœ€å¤§å¹¶å‘ï¼Œé»˜è®¤ 2
  rmsThreshold?: number;     // RMSé˜ˆå€¼ï¼Œé»˜è®¤ 0.05
}
```

### SchedulerConfig
```typescript
interface SchedulerConfig {
  minIntervalSec?: number;   // ç»å¯¹æœ€å°é—´éš”ï¼Œé»˜è®¤ 0.8s
  baseMinSec?: number;       // æŠ–åŠ¨æœ€å°å€¼ï¼Œé»˜è®¤ 3.0s
  baseMaxSec?: number;       // æŠ–åŠ¨æœ€å¤§å€¼ï¼Œé»˜è®¤ 10.0s
  maxConcurrency?: number;   // æœ€å¤§å¹¶å‘ï¼Œé»˜è®¤ 3
  upThreshold?: number;      // å‡æ¡£é˜ˆå€¼ï¼Œé»˜è®¤ 0.6
  downThreshold?: number;    // é™æ¡£é˜ˆå€¼ï¼Œé»˜è®¤ 0.45
}
```

## ğŸ¯ å·¥ä½œæµç¨‹

1. **éŸ³é¢‘é‡‡é›†**: é€šè¿‡Web Audio APIè·å–éŸ³é¢‘æµ
2. **ç‰¹å¾æå–**: ä½¿ç”¨Meydaæå–RMSã€é¢‘è°±ç­‰ç‰¹å¾
3. **é©±åŠ¨è®¡ç®—**: åŸºäºRMSè®¡ç®—é©±åŠ¨å€¼
4. **è°ƒåº¦å†³ç­–**: æ ¹æ®é©±åŠ¨å€¼å’Œå†å²çŠ¶æ€å†³å®šæ˜¯å¦è§¦å‘
5. **APIè°ƒç”¨**: å‘Edge APIå‘é€ç‰¹å¾æ•°æ®
6. **æµå¼è§£æ**: å®æ—¶è§£æNDJSONå“åº”
7. **å¼¹å¹•æ¸²æŸ“**: å°†è¯„è®ºæ³¨å…¥å¼¹å¹•å¼•æ“æ˜¾ç¤º

## ğŸ”„ çŠ¶æ€æœº

```
collecting â†’ style_locked â†’ streaming_comments â†’ done
     â†“              â†“              â†“
   å¼±ç½‘è¶…æ—¶      é¦–åŒ…åˆ°è¾¾      è¯„è®ºæµå®Œæˆ
     â†“              â†“              â†“
  å ä½æ€+æ¨¡æ¿    æ˜¾ç¤ºé£æ ¼      ç­‰å¾…ä¸‹æ¬¡è§¦å‘
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

- **è½¨é“ç®¡ç†**: å›ºå®š8æ¡è½¨é“ï¼Œé¿å…é¢‘ç¹DOMæ“ä½œ
- **æ‰¹é‡æ›´æ–°**: ä½¿ç”¨requestAnimationFrameåˆå¹¶æ¸²æŸ“
- **å¹¶å‘æ§åˆ¶**: é™åˆ¶åŒæ—¶è¯·æ±‚æ•°é‡ï¼Œé¿å…è¿‡è½½
- **é”™è¯¯æ¢å¤**: ç½‘ç»œå¤±è´¥æ—¶ä½¿ç”¨æœ¬åœ°æ¨¡æ¿å…œåº•

## ğŸ› ï¸ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°ç‰¹å¾
1. åœ¨Meydaé…ç½®ä¸­æ·»åŠ ç‰¹å¾æå–å™¨
2. æ›´æ–°FeatureTickæ¥å£
3. åœ¨è°ƒåº¦å™¨ä¸­æ·»åŠ ç‰¹å¾æƒé‡

### è‡ªå®šä¹‰å¼¹å¹•æ ·å¼
1. ä¿®æ”¹`danmu-engine.ts`ä¸­çš„æ ·å¼è®¾ç½®
2. æ·»åŠ åŸºäºç‰¹å¾çš„åŠ¨æ€æ ·å¼
3. æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰ä¸»é¢˜

### å¤šè¯­è¨€æ”¯æŒ
1. åœ¨APIè·¯ç”±ä¸­æ·»åŠ è¯­è¨€æ£€æµ‹
2. æ‰©å±•æ¨¡æ¿åº“æ”¯æŒå¤šè¯­è¨€
3. æ·»åŠ è¯­è¨€åˆ‡æ¢æ¥å£

## ğŸ› æ•…éšœæ’é™¤

### å¼¹å¹•ä¸æ˜¾ç¤º
- æ£€æŸ¥`#danmu-container`å…ƒç´ æ˜¯å¦å­˜åœ¨
- ç¡®è®¤å¼¹å¹•å¼•æ“å·²åˆå§‹åŒ–å¹¶å¯åŠ¨
- æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

### è‡ªåŠ¨è§¦å‘ä¸å·¥ä½œ
- æ£€æŸ¥RMSé˜ˆå€¼è®¾ç½®æ˜¯å¦è¿‡é«˜
- ç¡®è®¤éŸ³é¢‘ç‰¹å¾æ•°æ®æ­£å¸¸ä¼ é€’
- æŸ¥çœ‹è°ƒåº¦å™¨çŠ¶æ€å’Œé©±åŠ¨å€¼

### ç½‘ç»œè¯·æ±‚å¤±è´¥
- æ£€æŸ¥APIè·¯ç”±æ˜¯å¦æ­£ç¡®éƒ¨ç½²
- ç¡®è®¤CORSè®¾ç½®å…è®¸è·¨åŸŸè¯·æ±‚
- æŸ¥çœ‹ç½‘ç»œé¢æ¿çš„è¯·æ±‚è¯¦æƒ…

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0
- âœ… åŸºç¡€å¼¹å¹•å¼•æ“å®ç°
- âœ… æ™ºèƒ½è°ƒåº¦å™¨é›†æˆ
- âœ… æµå¼APIå®¢æˆ·ç«¯
- âœ… React Hookå°è£…
- âœ… ç§»åŠ¨ç«¯é€‚é…
- âœ… è‡ªåŠ¨è§¦å‘æœºåˆ¶

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Forké¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. å‘èµ·Pull Request

## ğŸ“„ è®¸å¯è¯

MIT License
