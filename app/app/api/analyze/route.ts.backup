export const runtime = 'edge';

type AnalyzeRequest = {
  window_ms?: number;
  features?: Record<string, unknown>;
  need_comments?: number;
  locale?: string;
  persona?: Record<string, unknown> | string;
  style?: string;
  confidence?: number;
  talking_points?: string[];
};

function encode(line: string) {
  return new TextEncoder().encode(line);
}

function sleep(ms: number) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// ç®€å•çš„å†…å­˜ç¼“å­˜ï¼ˆEdge Runtimeä¸­å¯ç”¨ï¼‰
const cache = new Map<
  string,
  {
    style: string;
    confidence: number;
    talking_points: string[];
    comments: string[];
  }
>();

// æ™ºè°±AIé…ç½®
const ZHIPU_API_URL = 'https://open.bigmodel.cn/api/paas/v4/chat/completions';
const ZHIPU_API_KEY = process.env.ZHIPU_API_KEY || '';
const ENABLE_COMMENT_FALLBACK = process.env.ENABLE_COMMENT_FALLBACK === 'true';

// è°ƒè¯•ï¼šæ£€æŸ¥APIå¯†é’¥æ˜¯å¦åŠ è½½
console.log(
  'ğŸµ ZHIPU_API_KEY çŠ¶æ€:',
  ZHIPU_API_KEY ? 'å·²é…ç½®' : 'æœªé…ç½®',
  ZHIPU_API_KEY ? `(${ZHIPU_API_KEY.substring(0, 10)}...)` : ''
);

// LLMç”Ÿæˆè¯„è®ºå‡½æ•°
async function generateCommentsWithLLM(
  style: string,
  talkingPoints: string[],
  features: Record<string, unknown>,
  need: number,
  locale: string
): Promise<string[]> {
  if (!ZHIPU_API_KEY) {
    if (!ENABLE_COMMENT_FALLBACK) {
      console.warn('æ™ºè°±AI APIå¯†é’¥æœªé…ç½®ï¼Œä¸”å·²ç¦ç”¨é»˜è®¤è¯„è®ºï¼Œè¿”å›ç©ºç»“æœ');
      return [];
    }
    console.warn('æ™ºè°±AI APIå¯†é’¥æœªé…ç½®ï¼Œä½¿ç”¨è§„åˆ™å¼•æ“fallback');
    return generateCommentsByStyle(style, talkingPoints, need, locale);
  }

  try {
    console.log('ğŸµ å¼€å§‹è°ƒç”¨æ™ºè°±AI API:', {
      style,
      talkingPoints,
      need,
      locale,
    });

    const prompt = `ä½ æ˜¯ä¸“ä¸šéŸ³ä¹è¯„è®ºäººï¼ŒåŸºäºä»¥ä¸‹éŸ³ä¹é£æ ¼å’Œç‰¹å¾ï¼Œç”Ÿæˆ${need}æ¡ç®€çŸ­çš„éŸ³ä¹è¯„è®ºï¼š

é£æ ¼: ${style}
ç‰¹å¾è¦ç‚¹: ${talkingPoints.join(', ')}
è¯­è¨€: ${locale === 'zh-CN' ? 'ä¸­æ–‡' : 'English'}

è¦æ±‚ï¼š
1. æ¯æ¡è¯„è®º30-50å­—ï¼ŒæŠ€æœ¯+æ„Ÿæ€§æ··åˆ
2. ä¸è¦é‡å¤ç‰¹å¾åï¼Œåªç»™ä¹è¯„æ„Ÿå—+æŠ€æœ¯æš—ç¤º
3. è¾“å‡ºJSONæ•°ç»„æ ¼å¼ï¼Œä¸è¦å…¶ä»–æ–‡å­—
4. è¯„è®ºè¦ä¸“ä¸šã€æœ‰è¶£ã€æœ‰è®°å¿†ç‚¹

ç¤ºä¾‹æ ¼å¼ï¼š
["è¯„è®º1", "è¯„è®º2", "è¯„è®º3"]`;

    console.log('ğŸµ å‘é€APIè¯·æ±‚åˆ°æ™ºè°±AI...');
    const response = await fetch(ZHIPU_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${ZHIPU_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'glm-4.5-air',
        messages: [
          {
            role: 'system',
            content:
              'ä½ æ˜¯ä¸“ä¸šéŸ³ä¹è¯„è®ºäººï¼Œæ“…é•¿åŸºäºéŸ³é¢‘ç‰¹å¾ç”Ÿæˆç®€æ´æœ‰è¶£çš„éŸ³ä¹è¯„è®ºã€‚',
          },
          {
            role: 'user',
            content: prompt,
          },
        ],
        temperature: 0.95,
        max_tokens: 2000,
        thinking: {
          type: 'disabled',
        },
        stream: false,
      }),
      signal: AbortSignal.timeout(4000), // 4ç§’è¶…æ—¶
    });

    console.log('ğŸµ APIå“åº”çŠ¶æ€:', response.status);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('ğŸµ APIè¯·æ±‚å¤±è´¥:', response.status, errorText);
      throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    console.log('ğŸµ APIè¿”å›æ•°æ®:', data);

    const content = data.choices?.[0]?.message?.content;

    if (!content) {
      console.error('ğŸµ APIè¿”å›å†…å®¹ä¸ºç©º:', data);
      throw new Error('APIè¿”å›å†…å®¹ä¸ºç©º');
    }

    console.log('ğŸµ è§£æAPIè¿”å›å†…å®¹:', content);

    // è§£æJSONæ•°ç»„
    const comments = JSON.parse(content);
    if (!Array.isArray(comments)) {
      console.error('ğŸµ APIè¿”å›æ ¼å¼ä¸æ­£ç¡®:', comments);
      throw new Error('APIè¿”å›æ ¼å¼ä¸æ­£ç¡®');
    }

    console.log('ğŸµ æˆåŠŸç”Ÿæˆè¯„è®º:', comments);
    return comments.slice(0, need);
  } catch (error) {
    if (!ENABLE_COMMENT_FALLBACK) {
      console.warn('LLMç”Ÿæˆå¤±è´¥ï¼Œä¸”å·²ç¦ç”¨é»˜è®¤è¯„è®ºï¼Œè¿”å›ç©ºç»“æœ:', error);
      return [];
    }
    console.warn('LLMç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨è§„åˆ™å¼•æ“fallback:', error);
    return generateCommentsByStyle(style, talkingPoints, need, locale);
  }
}

// ç”Ÿæˆç‰¹å¾hashç”¨äºç¼“å­˜
function generateFeatureHash(features: Record<string, unknown>): string {
  const key = [
    Math.round(Number(features.tempo_bpm) || 120),
    Math.round((Number(features.spectralFlatness_mean) || 0.5) * 100),
    Math.round((Number(features.spectralCentroid_mean) || 2000) / 100),
    Math.round((Number(features.rms_mean) || 0.1) * 1000),
  ].join('-');
  return key;
}

// å¿«é€Ÿè§„åˆ™å¼•æ“ - åŸºäºæ–‡æ¡£ä¸­çš„ç­–ç•¥
function fastHeuristic(features: Record<string, unknown>) {
  const tempo = Number(features.tempo_bpm) || 120;
  const flatness = Number(features.spectralFlatness_mean) || 0.5;
  const contrast = Array.isArray(features.spectralContrast_mean)
    ? (features.spectralContrast_mean as number[])[0] || 0.5
    : 0.5;
  const centroid = Number(features.spectralCentroid_mean) || 2000;
  const rms = Number(features.rms_mean) || 0.1;
  const zcr = Number(features.zcr_mean) || 0.1;
  const voice = Number(features.voiceProb_mean) || 0;
  const percussive = Number(features.percussiveRatio_mean) || 0;
  const harmonic = Number(features.harmonicRatio_mean) || 0;

  if (voice > 0.55 && tempo >= 90 && tempo <= 140) {
    return {
      style: 'pop_vocal',
      confidence: 0.86,
      talking_points: ['ä¸»å”±çªå‡º', 'æ—‹å¾‹æ€§å¼º', 'èŠ‚å¥æ˜å¿«', 'é€‚åˆç°åœºåˆå”±'],
    };
  } else if (percussive > 0.6 && tempo >= 118 && tempo <= 136) {
    return {
      style: 'techno_percussive',
      confidence: 0.83,
      talking_points: ['å¼ºçƒˆå››æ‹', 'æœºæ¢°è´¨æ„Ÿ', 'ä½é¢‘å†²å‡»', 'é€‚åˆèˆæ± '],
    };
  } else if (voice < 0.2 && harmonic > 0.55 && tempo < 110 && flatness > 0.5) {
    return {
      style: 'ambient_harmonic',
      confidence: 0.8,
      talking_points: ['æ°›å›´é“ºé™ˆ', 'å’Œå£°å †å ', 'æ…¢é€Ÿæ²‰æµ¸', 'ç©ºé—´æ„Ÿå¼º'],
    };
  } else if (tempo >= 130 && tempo <= 142 && centroid > 3000 && voice < 0.4) {
    return {
      style: 'trance_instrumental',
      confidence: 0.8,
      talking_points: ['æ¸è¿›é“ºå«', 'åˆæˆå™¨ä¸Šå‡çº¿', 'ç©ºé—´å»¶å±•', 'è¿·ç¦»æ°›å›´'],
    };
  } else if (tempo >= 100 && tempo <= 135 && zcr > 0.3 && voice > 0.35) {
    return {
      style: 'rock_vocal',
      confidence: 0.82,
      talking_points: ['å‰ä»–é©±åŠ¨', 'é¼“ç»„æ¨è¿›', 'äººå£°å¼ åŠ›', 'èˆå°èƒ½é‡'],
    };
  } else if (tempo >= 80 && tempo <= 110 && percussive > 0.45 && voice > 0.5) {
    return {
      style: 'hiphop_vocal',
      confidence: 0.78,
      talking_points: ['ä½é¢‘å¾‹åŠ¨', 'äººå£°è¯´å”±', 'èŠ‚å¥åˆ‡åˆ†', 'è¡—å¤´æ°›å›´'],
    };
  } else if (tempo >= 120 && tempo <= 140 && flatness < 0.45 && voice < 0.4) {
    return {
      style: 'edm_instrumental',
      confidence: 0.78,
      talking_points: ['å››è¸©èŠ‚å¥', 'åˆæˆå™¨å †å ', 'ä½é¢‘åŠ›é‡', 'èˆæ± å‹å¥½'],
    };
  } else if (tempo < 90 && flatness > 0.6 && harmonic > 0.5) {
    return {
      style: 'ambient_harmonic',
      confidence: 0.76,
      talking_points: ['æ°›å›´éŸ³ä¹', 'ç©ºçµæ„Ÿ', 'ç¼“æ…¢èŠ‚å¥', 'å†¥æƒ³æ„Ÿ'],
    };
  } else if (tempo >= 80 && tempo <= 160 && contrast > 0.7) {
    return {
      style: 'jazz_ensemble',
      confidence: 0.74,
      talking_points: ['å³å…´æ¼”å¥', 'å¤æ‚å’Œå£°', 'è‡ªç”±èŠ‚å¥', 'çˆµå£«å‘³é“'],
    };
  } else if (voice <= 0.3 && rms > 0.25 && percussive > 0.4) {
    return {
      style: 'electronic_instrumental',
      confidence: 0.72,
      talking_points: ['ç”µå­å¾‹åŠ¨', 'åˆæˆå™¨ä¸»å¯¼', 'èŠ‚å¥æ¨è¿›', 'ç°ä»£æ„Ÿ'],
    };
  } else {
    return {
      style: 'pop_instrumental',
      confidence: 0.68,
      talking_points: ['æ—‹å¾‹è½»ç›ˆ', 'å™¨ä¹ä¸»å¯¼', 'èŠ‚å¥é€‚ä¸­', 'èˆ’é€‚å¬æ„Ÿ'],
    };
  }
}

// åŸºäºé£æ ¼ç”Ÿæˆä¸ªæ€§åŒ–è¯„è®º - å·²ç¦ç”¨æ¨¡æ¿å¤‡ç”¨æ–¹æ¡ˆ
// function generateCommentsByStyle(
//   style: string,
//   talkingPoints: string[],
//   need: number,
//   locale: string
// ): string[] {
//   const templates: Record<string, Record<string, string[]>> = {
//     pop_vocal: {
//       'zh-CN': [
//         'ä¸»å”±çš„æƒ…ç»ªçº¿å¾ˆæŠ“äººï¼Œå‰¯æ­Œæ‹‰å‡æ—¶å’Œå£°å †å¾—æ°åˆ°å¥½å¤„ã€‚',
//         'äººå£°è´¨æ„Ÿæ¸©æš–ï¼Œé…åˆæµç•…çš„é¼“ç‚¹å¾ˆå®¹æ˜“è®©äººå“¼å”±ã€‚',
//         'ä¸»æ­Œé“ºå«å…‹åˆ¶ï¼Œåˆ°äº†å‰¯æ­Œçˆ†å‘å‡ºå……ç›ˆçš„å…±é¸£æ„Ÿã€‚',
//         'äººå£°å ä¸»å¯¼ï¼ŒèƒŒæ™¯åˆæˆå™¨åšäº†æŸ”å’Œçš„æ‰˜åº•ï¼Œéå¸¸é€‚åˆç”µå°æ’­æ”¾ã€‚',
//       ],
//       en: [
//         'Lead vocal shines with a warm tone and a memorable hook.',
//         'Voice-driven mix keeps the groove light yet catchy.',
//         'Verses stay restrained before the chorus blooms with harmonies.',
//         'Vocal-forward production with soft synth beds, radio ready.',
//       ],
//     },
    pop_instrumental: {
      'zh-CN': [
        'å»æ‰äººå£°åï¼Œæ—‹å¾‹çº¿ä¾ç„¶æµç•…ï¼Œåˆæˆå™¨å’Œå¼¦é“ºå¾—å¾ˆæ»¡ã€‚',
        'å™¨ä¹ä¸»å¯¼çš„ç¼–æ’ï¼Œé€‚åˆå½“æˆæ—¥å¸¸èƒŒæ™¯éŸ³ä¹ã€‚',
        'å¾‹åŠ¨è½»ç›ˆï¼Œæ—‹å¾‹çº¿æ¡æ¸…æ™°ï¼Œæ˜¯ä¸€é¦–èˆ’æœçš„å™¨ä¹æµè¡Œã€‚',
        'èŠ‚å¥ç¨³ç¨³æ¨è¿›ï¼Œåˆæˆå™¨å’Œå‰ä»–æŠŠæ°›å›´æ‹‰å¾—å¾ˆæŸ”å’Œã€‚',
      ],
      en: [
        'Instrumental pop with a clean melodic contour and lush pads.',
        'Laid-back groove makes it perfect for everyday listening.',
        'Without vocals it still carries a strong hook via synth leads.',
        'Balanced rhythm section with gentle guitars keeps it breezy.',
      ],
    },
    techno_percussive: {
      'zh-CN': [
        'é¼“æœºçš„å››è¸©ç¨³åˆ°ä¸è¡Œï¼Œé‡‘å±è´¨æ„Ÿçš„åˆæˆå™¨è®©èˆæ± ç¬é—´å‡æ¸©ã€‚',
        'æ‰“å‡»ä¹å±‚å å¾—å¾ˆå¯†ï¼Œå·¥ä¸šæ°›å›´çš„ç»†èŠ‚æå…·ç”»é¢æ„Ÿã€‚',
        'ä½é¢‘å’Œå‡»æŒå£°æŠŠèƒ½é‡ç›´æ¥å †åˆ°é¡¶ï¼Œå¾ˆé€‚åˆä½œä¸ºæš–åœºæ®µè½ã€‚',
        'é‡å¤çš„å¾‹åŠ¨é…åˆçªå‡ºçš„æ‰“å‡»å£°ï¼Œç´§å¼ æ„Ÿä¸€æ­¥æ­¥æ¸—é€ã€‚',
      ],
      en: [
        'Relentless four-on-the-floor kick with metallic percussive stabs.',
        'Dense percussion layers create an immersive industrial vibe.',
        'Low-end thrust paired with claps keeps the energy peaking.',
        'Repetitive groove and sharp drums build hypnotic tension.',
      ],
    },
    ambient_harmonic: {
      'zh-CN': [
        'å’Œå£°å«åº•æ¸©æŸ”ç»µå»¶ï¼Œåƒæ˜¯ä¸€åœºæ¸å…¥çš„æ¸…æ™¨é›¾æ°”ã€‚',
        'æ…¢é€Ÿæ¨è¿›çš„å’Œå¼¦ç¾¤ï¼Œè¥é€ å‡ºæ— é‡åŠ›çš„æ²‰æµ¸æ°›å›´ã€‚',
        'æ²¡æœ‰æ˜æ˜¾èŠ‚å¥ï¼Œé å’Œå£°å’Œç©ºé—´æ··å“æ’‘èµ·æ•´é¦–ä½œå“ã€‚',
        'éå¸¸é€‚åˆå†¥æƒ³æˆ–é˜…è¯»ï¼ŒèƒŒæ™¯å±‚æ¬¡ç»†è…»è€Œå…‹åˆ¶ã€‚',
      ],
      en: [
        'Soft harmonic pads drift like dawn fog settling in slow motion.',
        'Glacial chord progressions build a weightless ambience.',
        'No defined beat, just layers of harmony and reverb breathing.',
        'Perfect for meditation or reading, understated yet detailed.',
      ],
    },
    rock_vocal: {
      'zh-CN': [
        'ä¸»å”±çš„å˜¶å¼å’Œå‰ä»–å¤±çœŸå åœ¨ä¸€èµ·ï¼Œå¾ˆæœ‰ç°åœºæ„Ÿã€‚',
        'é¼“ç»„å’Œè´æ–¯æŠŠéª¨æ¶æ‰“å¾—æ‰å®ï¼Œäººå£°é¡¶åœ¨å‰é¢éå¸¸ç‚¸ã€‚',
        'å‰¯æ­Œç¬é—´ç‚¸å¼€ï¼Œå’¬å­—ä¸æƒ…ç»ªæ§åˆ¶å¾—å¾ˆå¥½ã€‚',
        'ç»å…¸çš„å‰ä»–+ä¸»å”±ç»„åˆï¼Œèƒ½é‡ä»ç¬¬ä¸€æ‹å°±æº¢å‡ºã€‚',
      ],
      en: [
        'Lead vocal grit rides atop crunchy guitars with live energy.',
        'Solid rhythm section lets the vocal punch straight through.',
        'Chorus explodes instantly, vocals control the grit and emotion.',
        'Classic vocal-and-guitar pairing overflowing with energy.',
      ],
    },
    hiphop_vocal: {
      'zh-CN': [
        'ä½é¢‘é¢—ç²’æ„Ÿåè¶³ï¼Œäººå£°flowåˆ‡åˆ†å¾ˆèˆ’æœã€‚',
        'é¼“ç‚¹å¼ºåŠ²ï¼Œé…åˆè¯´å”±çš„æŠ¼éŸµæ‰‹æ³•è®©äººæƒ³ç‚¹å¤´ã€‚',
        'äººå£°å±‚æ¬¡ä¸°å¯Œï¼Œåˆæˆå™¨ç‚¹ç¼€æ°åˆ°å¥½å¤„ã€‚',
        'æœ‰åŠ›çš„é¼“ç»„ä¸é¥±æ»¡çš„è´æ–¯ï¼Œholdä½å…¨åœºæ°”æ°›ã€‚',
      ],
      en: [
        'Punchy low end with a relaxed yet precise vocal flow.',
        'Hard-hitting drums and rhyme schemes that demand a head nod.',
        'Vocal stacks and ad-libs keep the narrative dynamic.',
        'Solid drums and bass glue the entire vibe together.',
      ],
    },
    jazz_ensemble: {
      'zh-CN': [
        'é“œç®¡ä¸é’¢ç´çš„å¯¹è¯å¾ˆç²¾å½©ï¼ŒèŠ‚å¥ç»„æ”¶æ”¾è‡ªå¦‚ã€‚',
        'ä¸»æ—‹å¾‹å’Œå³å…´æ®µè½è¡”æ¥è‡ªç„¶ï¼Œåƒæ˜¯ä¸€åœºå°å‹çˆµå£«æ¼”å‡ºã€‚',
        'å’Œå£°ä¸°å¯Œã€åŠ¨æ€çµæ´»ï¼Œæ˜¯å…¸å‹çš„å°ç¼–åˆ¶çˆµå£«æ°›å›´ã€‚',
        'é¼“ä¸è´æ–¯æ‰“å¾—æ¾å¼›ï¼Œç•™å‡ºç©ºé—´ç»™å³å…´æ—‹å¾‹ã€‚',
      ],
      en: [
        'Horns and piano trade phrases with an intimate ensemble feel.',
        'Themes blend seamlessly with improvisation, like a live session.',
        'Rich harmonies and agile dynamics define this small-group jazz.',
        'Relaxed drums and bass leave room for melodic improvisation.',
      ],
    },
    trance_instrumental: {
      'zh-CN': [
        'åˆæˆå™¨åˆ»ç”»å‡ºé€æ­¥ä¸Šå‡çš„æ—‹å¾‹çº¿ï¼Œæƒ…ç»ªå»¶ä¼¸å¾ˆåˆ°ä½ã€‚',
        'é“ºåº•çš„padå’Œå»¶è¿Ÿè®©ç©ºé—´æ„Ÿçˆ†æ£šï¼Œå…¸å‹çš„Tranceç¼–æ’ã€‚',
        'æ²¡æœ‰äººå£°ä¹Ÿä¸ç©ºï¼Œåˆæˆå™¨ç¶éŸ³æœ¬èº«å°±æ˜¯äº®ç‚¹ã€‚',
        'é€‚åˆDJæ®µè½çš„è¿‡æ¸¡ï¼Œèƒ½é‡å¾ªåºæ¸è¿›åœ°å †å ã€‚',
      ],
      en: [
        'Layered synth arps rise steadily, building emotional lift.',
        'Pads and delays create huge spatial presenceâ€”classic trance.',
        'No vocal required; the arpeggios carry the spotlight.',
        'Ideal transition piece with energy that keeps climbing.',
      ],
    },
    edm_instrumental: {
      'zh-CN': [
        'å››æ‹é¼“ç‚¹ç¨³æ‰ç¨³æ‰“ï¼Œåˆæˆå™¨riffæ˜¯ä¸»è§’ã€‚',
        'Dropéƒ¨åˆ†èƒ½é‡é›†ä¸­ï¼Œä½é¢‘å†²å‡»åŠ›å¼ºã€‚',
        'æ—‹å¾‹æ¸…æ™°ï¼Œé€‚åˆèˆæ± çš„å™¨ä¹EDMã€‚',
        'èŠ‚å¥ç²¾å‡†ï¼Œåˆæˆå™¨å±‚æ¬¡åˆ†æ˜ã€‚',
      ],
      en: [
        'Four-on-the-floor kick anchors a synth-driven instrumental.',
        'Drop hits hard with focused low-end impact.',
        'Clear melodic riff keeps the instrumental EDM engaging.',
        'Precise rhythm with well-layered synth textures.',
      ],
    },
    electronic_instrumental: {
      'zh-CN': [
        'åå™¨ä¹çš„ç”µå­ç¼–æ’ï¼Œå¾‹åŠ¨è½»ç›ˆå¸¦ä¸€ç‚¹æœªæ¥æ„Ÿã€‚',
        'åˆæˆå™¨ä¸é¼“æœºçš„é…åˆæ¾å¼›æœ‰åº¦ï¼Œé€‚åˆæ—¥å¸¸è†å¬ã€‚',
        'ä¸­ä½é¢‘æŸ”å’Œï¼Œçº¿æ¡å¹²å‡€ï¼Œæ˜¯ä¸€é¦–æ°”è´¨å‹ç”µå­æ›²ã€‚',
        'ç®€æ´çš„èŠ‚å¥æ­é…æ¶¦æ³½çš„åˆæˆå™¨ï¼Œæ°›å›´æ„Ÿæ»¡æ»¡ã€‚',
      ],
      en: [
        'Instrumental electronic with a light, futuristic groove.',
        'Relaxed drum-machine patterns paired with airy synths.',
        'Soft low-end and clean linesâ€”an understated electronic gem.',
        'Minimal rhythm plus lush synths create a mood-forward track.',
      ],
    },
    'EDM/House': {
      'zh-CN': [
        'é¼“ç‚¹æ‰å®ä¸”128BPMçš„å››è¸©æ„Ÿå¾ˆç¨³ï¼Œä½é¢‘æ»šåŠ¨è®©èˆæ± å¼ åŠ›èµ·æ¥äº†ã€‚',
        'é«˜é¢‘è´¨å¿ƒåä¸Šï¼Œåˆæˆå™¨äº®åº¦è¶³ï¼Œä¸»æ—‹å¾‹æœ‰æ¸…æ™°çš„hookä½ã€‚',
        'ç”µå­èŠ‚æ‹æ¨è¿›æ„Ÿå¼ºï¼Œé€‚åˆèˆæ± å¾‹åŠ¨ã€‚',
        'åˆæˆå™¨å±‚æ¬¡åˆ†æ˜ï¼ŒéŸ³è‰²ç°ä»£æ„Ÿåè¶³ã€‚',
        'ä½é¢‘æœ‰å¼¹æ€§ï¼Œä¸­é«˜é¢‘æ¸…æ™°ï¼Œæ•´ä½“èƒ½é‡å……æ²›ã€‚',
        'èŠ‚æ‹ç¨³å®šï¼Œå¾‹åŠ¨æ„Ÿå¼ºï¼Œè®©äººæƒ³è·Ÿç€æ‘‡æ‘†ã€‚',
      ],
      en: [
        'Solid 128BPM four-on-the-floor groove with driving low-end.',
        'Bright synths with clear hook positioning in the high frequencies.',
        'Strong electronic pulse, perfect for dance floor movement.',
        'Layered synths with modern sound design.',
        'Punchy bass with clear mids and highs, energetic overall.',
        'Steady beat with strong rhythm, makes you want to move.',
      ],
    },
    Techno: {
      'zh-CN': [
        'å·¥ä¸šæ„Ÿåè¶³ï¼Œæœºæ¢°å¾‹åŠ¨å¾ˆå¸¦æ„Ÿï¼Œé‡å¤çš„èŠ‚æ‹è¥é€ å‡ºå‚¬çœ æ•ˆæœã€‚',
        'ç§‘æŠ€æ„ŸéŸ³è‰²ï¼Œæœªæ¥æ„Ÿå¾ˆå¼ºï¼Œä½é¢‘åšé‡ï¼Œä¸­é¢‘æ¸…æ™°ã€‚',
        'æœºæ¢°åŒ–çš„èŠ‚æ‹æ¨¡å¼ï¼Œè¥é€ å‡ºå·¥ä¸šæ°›å›´ã€‚',
        'é‡å¤æ€§å¼ºçš„å¾‹åŠ¨ï¼Œå…·æœ‰å‚¬çœ èˆ¬çš„é­…åŠ›ã€‚',
        'ç§‘æŠ€æ„Ÿåè¶³çš„éŸ³è‰²è®¾è®¡ï¼Œå±‚æ¬¡åˆ†æ˜ã€‚',
        'å·¥ä¸šé£æ ¼çš„èŠ‚æ‹ï¼Œè¥é€ å‡ºç‹¬ç‰¹çš„æœºæ¢°ç¾æ„Ÿã€‚',
      ],
      en: [
        'Industrial feel with mechanical rhythm, hypnotic repetitive beats.',
        'Futuristic sound design with heavy low-end and clear mids.',
        'Mechanical beat patterns creating industrial atmosphere.',
        'Repetitive rhythms with hypnotic appeal.',
        'Tech-heavy sound design with clear layering.',
        'Industrial-style beats with unique mechanical beauty.',
      ],
    },
    Rock: {
      'zh-CN': [
        'å‰ä»–riffå¾ˆæœ‰åŠ›é‡æ„Ÿï¼Œé¼“ç‚¹æ‰å®ï¼ŒèŠ‚æ‹ç¨³å®šã€‚',
        'æ•´ä½“åŠ¨æ€èŒƒå›´å¤§ï¼Œè¡¨ç°åŠ›å¼ºï¼Œæ‘‡æ»šçš„ç²—çŠ·å’Œç»†è…»å¹¶å­˜ã€‚',
        'ç”µå‰ä»–éŸ³è‰²é¥±æ»¡ï¼Œé¼“ç»„åè°ƒï¼ŒèŠ‚å¥æ„Ÿå¼ºã€‚',
        'æ‘‡æ»šç²¾ç¥åè¶³ï¼Œèƒ½é‡å……æ²›ï¼Œæ„ŸæŸ“åŠ›å¼ºã€‚',
        'å‰ä»–soloéƒ¨åˆ†å¾ˆæœ‰è¡¨ç°åŠ›ï¼Œé¼“ç‚¹æ¨è¿›æ„Ÿå¼ºã€‚',
        'æ•´ä½“åˆ¶ä½œç²¾è‰¯ï¼Œæ‘‡æ»šå…ƒç´ ä¸°å¯Œï¼Œå±‚æ¬¡åˆ†æ˜ã€‚',
      ],
      en: [
        'Powerful guitar riffs with solid drums and steady rhythm.',
        'Wide dynamic range with strong expression, raw and refined.',
        'Full electric guitar tone with coordinated drums.',
        'Strong rock spirit with energetic and infectious sound.',
        'Expressive guitar solos with driving drum patterns.',
        'Well-produced with rich rock elements and clear layering.',
      ],
    },
    Pop: {
      'zh-CN': [
        'æ—‹å¾‹ä¼˜ç¾ï¼ŒèŠ‚å¥æ„Ÿå¼ºï¼Œäººå£°çªå‡ºï¼Œå’Œå£°ä¸°å¯Œã€‚',
        'æµè¡Œå…ƒç´ æ˜æ˜¾ï¼Œæœ—æœ—ä¸Šå£ï¼Œç¼–æ›²å±‚æ¬¡æ¸…æ™°ã€‚',
        'åˆ¶ä½œç²¾è‰¯ï¼Œæ—‹å¾‹è®°å¿†ç‚¹å¼ºï¼Œå®¹æ˜“ä¼ å”±ã€‚',
        'èŠ‚å¥æ˜å¿«ï¼Œäººå£°å¤„ç†ç»†è…»ï¼Œæ•´ä½“å¹³è¡¡ã€‚',
        'æµè¡Œæ„Ÿåè¶³ï¼Œæ—‹å¾‹æµç•…ï¼Œåˆ¶ä½œæ°´å‡†é«˜ã€‚',
        'æœ—æœ—ä¸Šå£çš„æ—‹å¾‹ï¼ŒèŠ‚å¥æ„Ÿå¼ºï¼Œåˆ¶ä½œç²¾è‰¯ã€‚',
      ],
      en: [
        'Beautiful melody with strong rhythm, prominent vocals and rich harmonies.',
        'Clear pop elements, catchy and memorable with layered arrangement.',
        'Well-produced with strong melodic hooks, easy to sing along.',
        'Upbeat rhythm with delicate vocal processing, well-balanced.',
        'Strong pop appeal with smooth melody and high production value.',
        'Catchy melody with strong rhythm and excellent production.',
      ],
    },
  };

  const baseFallbackMap: Record<string, string> = {
    pop_vocal: 'Pop',
    pop_instrumental: 'Pop',
    techno_percussive: 'Techno',
    ambient_harmonic: 'Ambient',
    rock_vocal: 'Rock',
    hiphop_vocal: 'Hip-Hop',
    trance_instrumental: 'Trance',
    edm_instrumental: 'EDM/House',
    electronic_instrumental: 'Electronic',
    jazz_ensemble: 'Jazz',
  };

  const fallbackKey = baseFallbackMap[style] || 'EDM/House';
  const styleTemplates =
    templates[style] || templates[fallbackKey] || templates['EDM/House'];
  const baseComments = styleTemplates[locale] || styleTemplates['zh-CN'];

  // ç»“åˆtalking pointsç”Ÿæˆæ›´å¤šä¸ªæ€§åŒ–è¯„è®º
  const personalizedComments = talkingPoints.map(point => {
    const variations = [
      `${point}ç‰¹å¾æ˜æ˜¾ï¼ŒéŸ³è‰²å±‚æ¬¡ä¸°å¯Œã€‚`,
      `${point}æ„Ÿå¾ˆå¼ºï¼Œæ•´ä½“è¡¨ç°åŠ›ä½³ã€‚`,
      `${point}å…ƒç´ çªå‡ºï¼Œåˆ¶ä½œç²¾è‰¯ã€‚`,
      `${point}å¤„ç†åˆ°ä½ï¼Œå€¼å¾—ä¸€å¬ã€‚`,
    ];
    return variations[Math.floor(Math.random() * variations.length)];
  });

  // åˆå¹¶åŸºç¡€æ¨¡æ¿å’Œä¸ªæ€§åŒ–è¯„è®º - å·²ç¦ç”¨
  // const allComments = [...baseComments, ...personalizedComments];

  // // éšæœºé€‰æ‹©å¹¶å»é‡
  // const selected: string[] = [];
  // while (selected.length < need && selected.length < allComments.length) {
  //   const comment = allComments[Math.floor(Math.random() * allComments.length)];
  //   if (!selected.includes(comment)) {
  //     selected.push(comment);
  //   }
  // }

  // ç¦ç”¨æ¨¡æ¿å‡½æ•°ï¼Œå¼ºåˆ¶ä½¿ç”¨LLM
  return [];
}

export async function POST(req: Request) {
  let input: AnalyzeRequest = {};
  try {
    input = await req.json();
  } catch {}

  const need = Math.max(1, Math.min(8, Number(input.need_comments ?? 4)));
  const locale = (input.locale as string) || 'zh-CN';
  const features = input.features || {};

  // æ£€æŸ¥ç¼“å­˜
  const featureHash = generateFeatureHash(features);
  const cacheKey = `${featureHash}-${locale}-${need}`;

  let style: string,
    confidence: number,
    talking_points: string[],
    comments: string[];

  if (cache.has(cacheKey)) {
    // ç¼“å­˜å‘½ä¸­ï¼Œç«‹å³è¿”å›
    const cached = cache.get(cacheKey)!;
    style = cached.style;
    confidence = cached.confidence;
    talking_points = cached.talking_points;
    comments = cached.comments.slice(0, need);
  } else {
    // ç¼“å­˜æœªå‘½ä¸­ï¼Œä½¿ç”¨å¿«é€Ÿè§„åˆ™å¼•æ“è¿›è¡Œé£æ ¼æ£€æµ‹ï¼ˆ<5mså“åº”ï¼‰
    const result = fastHeuristic(features);
    style = result.style;
    confidence = result.confidence;
    talking_points = result.talking_points;

    // ä½¿ç”¨LLMç”Ÿæˆä¸ªæ€§åŒ–è¯„è®ºï¼ˆå¸¦fallbackï¼‰
    comments = await generateCommentsWithLLM(
      style,
      talking_points,
      features,
      need,
      locale
    );

    // ç¼“å­˜ç»“æœï¼ˆé™åˆ¶ç¼“å­˜å¤§å°ï¼‰
    if (cache.size < 100) {
      cache.set(cacheKey, { style, confidence, talking_points, comments });
    }
  }

  const stream = new ReadableStream<Uint8Array>({
    async start(controller) {
      // ç«‹å³è¿”å›é£æ ¼æ£€æµ‹ç»“æœï¼ˆ<5mså“åº”ï¼‰
      controller.enqueue(
        encode(
          JSON.stringify({
            type: 'style',
            style: style,
            confidence: confidence,
          }) + '\n'
        )
      );

      // æµå¼è¿”å›è¯„è®ºï¼ˆæ¨¡æ‹ŸLLMç”Ÿæˆè¿‡ç¨‹ï¼‰
      for (let i = 0; i < comments.length; i++) {
        // æ¨¡æ‹Ÿç”Ÿæˆå»¶è¿Ÿï¼šé¦–æ¡å¿«é€Ÿï¼Œåç»­ç¨æ…¢
        const delay = i === 0 ? 100 : 200 + Math.floor(Math.random() * 200);
        await sleep(delay);

        controller.enqueue(
          encode(
            JSON.stringify({ type: 'comment', idx: i, text: comments[i] }) +
              '\n'
          )
        );
      }

      controller.enqueue(encode(JSON.stringify({ type: 'done' }) + '\n'));
      controller.close();
    },
  });

  return new Response(stream, {
    headers: {
      'Content-Type': 'application/x-ndjson',
      'Cache-Control': 'no-store',
    },
  });
}
