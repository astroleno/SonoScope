# SonoScope 项目计划 (MVP → 发布)

## 1. 范围与目标
- 移动优先的实时可视化，首屏绘制 ≤ 1秒，首条弹幕 ≤ 1秒
- 稳定的风格切换（无抖动），弱网/无网络时降级可用
- 统一数据契约 + 插件热插拔；LLM 作为可选增强功能
- 无障碍：WCAG 2.1 AA 基线，纯键盘可用，屏幕阅读器兼容

参考文档：docs/01-overview-scope.md, docs/02-nonfunctional.md

## 2. 里程碑与时间线
- M1 原型阶段 (2周)：音频接入 + 特征提取 + 事件总线 + 1个可视化 + 本地弹幕 + 无障碍基线
- M2 集成阶段 (2周)：第2个可视化 + 预设插值 + GLM-4.5 + 移动端优化 + 键盘导航完善
- M3 发布阶段 (1周)：插件注册表/配置页面 + 性能/稳定性强化 + 文档/演示 + 无障碍审计

参考文档：docs/09-milestones-testing.md

## 3. 工作流与任务

### A. 音频与特征提取
- [ ] A1: 麦克风权限流程（桌面/移动端手势解锁）[M1]
- [ ] A2: AudioWorklet 管道 + 分析器节点连接 [M1]
- [ ] A3: 特征提取（rms、centroid、flux、onsetRate）[M1]
- [ ] A4: 条件性 pitch/bpm 更新（稳定性门控）[M2]
- [ ] A5: 性能调优：FFT 大小、跳跃长度、背压处理 [M2]

### B. 事件总线与契约
- [ ] B1: 轻量级事件总线抽象 [M1]
- [ ] B2: 定义 FeatureTick/DecisionEvent（版本化）[M1]
- [ ] B3: JSON Schema + ajv 验证 + 严格失败丢弃 [M1]
- [ ] B4: 遥测事件（fps、rtt、降级统计）[M2]

### C. 可视化插件 (p5)
- [ ] C1: 插件接口（init/applyPreset/renderTick/dispose）[M1]
- [ ] C2: 预设插值的 TransitionManager [M2]
- [ ] C3: 可视化1（基础粒子）[M1]
- [ ] C4: 可视化2（trap/波形变体）[M2]
- [ ] C5: 能力声明 + 参数白名单 [M2]

### D. 弹幕系统
- [ ] D1: 本地短语库 + 模板系统 [M1]
- [ ] D2: 相似性去重（最近10秒）[M2]
- [ ] D3: A/B 路由：本地优先，稳态时调用 LLM [M2]

### E. LLM 集成 (GLM-4.5)
- [ ] E1: Edge 令牌签发 + 限流（可选）[M2]
- [ ] E2: 纯 JSON 输出提示 + schema 验证 [M2]
- [ ] E3: 超时、重试和降级到本地 [M2]

### F. 无障碍功能 (a11y)
- [ ] F1: 键盘优先导航；可见焦点；逃生通道 [M1]
- [ ] F2: ARIA 实时区域用于状态/公告 [M1]
- [ ] F3: 高对比度模式 + 减少动画开关 [M2]
- [ ] F4: 屏幕阅读器冒烟测试（VoiceOver/NVDA）[M3]

### G. 移动端优化
- [ ] G1: 手势启动 AudioContext 激活 [M1]
- [ ] G2: 弱设备自适应粒子密度/分辨率 [M2]
- [ ] G3: iOS Safari 特殊处理 + WebGL 降级 [M2]

### H. 边缘/后端（可选）
- [ ] H1: Vercel Edge 函数用于短期令牌 [M2]
- [ ] H2: 配置下发和特性开关 [M2]

### I. 可观测性与诊断
- [ ] I1: 客户端指标（ttfb_ms、fps、llm_rtt_ms）[M2]
- [ ] I2: 错误日志 + 用户友好的恢复路径 [M2]
- [ ] I3: 开发构建的控制台/面板 [M3]

### J. 安全与隐私
- [ ] J1: 默认仅本地音频；显式云端开关 [M1]
- [ ] J2: 数据最小化（仅特征，无原始音频）[M1]
- [ ] J3: TLS、域名白名单、最小权限令牌 [M2]

### K. 文档与开发体验
- [ ] K1: 分离文档框架（已完成）[M1]
- [ ] K2: 开发设置指南 + 脚本对照表 [M2]
- [ ] K3: 插件指南 + 模板（CLI 可选）[M2]
- [ ] K4: 无障碍检查清单 + 测试指南 [M3]
- [ ] K5: 演示站点 / 示例完善 [M3]

## 4. 各里程碑交付物
- M1：运行原型（麦克风→特征→可视化1→本地弹幕）、schema 验证、基础无障碍、文档框架
- M2：可视化2 + 过渡效果、GLM-4.5 集成（严格 JSON）、移动端优化、遥测、强化的用户体验
- M3：注册表/配置界面、性能优化、完整文档、无障碍审计报告

## 5. 验收标准
- 性能：桌面 ≥45fps，移动 ≥30fps（10分钟运行）；首条弹幕 <1秒；后续平均 <800ms
- 稳定性：风格切换无抖动循环；错误时干净降级
- 无障碍：纯键盘流程通过；屏幕阅读器关键动作可理解；AA 级对比度

参考文档：docs/02-nonfunctional.md, docs/09-milestones-testing.md

## 6. 风险与缓解策略
- 风格抖动 → 进入/退出阈值 + 冷却时间 + EMA/中位数
- 移动端功耗/发热 → 条件性更新 + 自适应密度 + 可选 OffscreenCanvas
- 网络波动 → LLM 可选增强；本地弹幕完整；仅上传特征
- 插件碎片化 → 参数白名单 + 能力声明 + schema 限制

参考文档：docs/11-risks.md

## 7. 依赖与假设
- Node 18+, pnpm 8+, 现代浏览器（Web Audio + OffscreenCanvas 降级）
- 可选：Vercel Edge 用于令牌/配置；GLM-4.5 访问权限

## 8. 跟踪与仪式
- 站会（异步10分钟），每周里程碑回顾，每个 Mx 结束后回顾
- Issue 标签：[M1]/[M2]/[M3]，领域：audio/features/visuals/a11y/llm/docs
- fps/rtt/fallback_rate 指标面板；类型/检查/测试的 CI 门禁

## 9. 指引文档
- 精简版 PRD：PRD_Lite.md
- 分离文档索引：docs/README.md
- 契约：docs/04-events-contracts.md
- 插件规范：docs/05-plugin-spec.md
- LLM 策略：docs/06-llm-strategy.md

---

## 计划评估总结

### ✅ 计划优势
1. **结构清晰合理**：按功能模块组织，里程碑定义明确
2. **技术考虑周全**：涵盖音频处理、可视化、LLM集成、无障碍等所有关键方面
3. **风险识别准确**：正确识别了主要技术风险并提出具体缓解方案
4. **无障碍集成良好**：将无障碍作为核心功能而非附加功能
5. **交付物明确**：每个里程碑都有具体的可交付成果

### ⚠️ 需要注意的挑战
1. **时间线紧张**：5周完成如此复杂的项目（特别是移动端优化和LLM集成）很有挑战性
2. **M1负担较重**：2周内完成音频处理、可视化、本地弹幕和无障碍基线较为紧张
3. **移动端复杂度**：iOS Safari特殊处理和性能优化可能需要更多时间
4. **LLM集成风险**：获取稳定的JSON输出和处理边缘情况通常比预期复杂

### 📋 建议调整
1. **考虑延长时间线**：8-10周会更现实，或适当缩减范围
2. **更详细的任务分解**：为复杂任务添加子任务和工时估算
3. **增强测试覆盖**：添加专门的集成测试和用户测试任务
4. **明确质量标准**：为每个任务定义"完成"的标准

总体而言，这是一个技术扎实、考虑全面的项目计划，但需要合理的时间预期和可能的范围调整来确保成功交付。