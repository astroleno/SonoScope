# 弹幕组件开发 TODO

基于 `弹幕组件.md` 设计文档的完整实现计划

## 📋 总体进度

- [x] **Phase 0: 基础框架** - 已完成
- [x] **Phase 1: 特征提取增强** - 已完成 (100%)
- [x] **Phase 2: 稳定判定器** - 已完成 (100%)
- [x] **Phase 2.5: 轻量曲风/乐器识别** - 已完成 (70%)
- [x] **Phase 2.6: 预训练乐器分类模型接入** - 已完成 (80%)
- [ ] **Phase 3: LLM集成** - 待开始
- [ ] **Phase 4: 性能优化** - 待开始

---

## 🎯 Phase 1: 特征提取增强 ✅ 已完成 (100%)

### 1.1 扩展Meyda特征提取器 ✅
- [x] 添加Chroma特征提取 (12维)
- [x] 添加PCP (Pitch Class Profile) 特征 (12维，Meyda `chroma` 已覆盖)
- [x] 添加Spectral Contrast特征 (6维)
- [x] 添加Spectral Bandwidth特征
- [x] 添加Spectral Rolloff特征
- [x] 添加Dynamic Range计算
- [x] 添加Loudness (LKFS) 计算 ✅ 已实现

### 1.2 实现2-4s窗口聚合 ✅
- [x] 创建滑动窗口缓冲区
- [x] 计算特征统计量 (均值/方差/峰值)
- [x] 实现Tempo BPM估计 (每0.5-1s更新)
- [x] 实现Beat Strength计算
- [x] 添加特征平滑算法 (EMA)

### 1.3 特征数据接口标准化 ✅
- [x] 定义完整的FeatureWindow接口
- [x] 实现特征归一化函数 ✅ 已实现
- [x] 添加特征验证和边界检查 ✅ 已实现
- [x] 创建特征序列化/反序列化 ✅ 已实现

**预期时间**: 2-3天
**验收标准**: 能够提取完整的音频特征集，支持2-4s窗口统计

---

## 🎯 Phase 2: 稳定判定器 ✅ 已完成 (100%)

### 2.1 风格稳定度检测 ✅
- [x] 实现Centroid方差检测
- [x] 实现Chroma能量稳定性检测
- [x] 实现Tempo变化率检测
- [x] 添加稳定度阈值配置
- [x] 实现1.5-2.0s持续时长检测

### 2.2 触发条件优化 ✅
- [x] 实现多条件组合判定
- [x] 添加迟滞机制防止抖动
- [x] 实现触发状态机
- [x] 添加调试日志和可视化

### 2.3 风格分类器 ✅
- [x] 实现Rule-based风格判定
- [x] 添加EDM/House/Techno等风格规则
- [x] 实现风格置信度计算
- [x] 添加风格切换检测

**预期时间**: 1-2天
**验收标准**: 能够稳定检测音频风格，避免频繁切换

---

## 🎯 Phase 2.5: 轻量曲风/乐器识别路线 ✅ 已完成 (70%)

### 2.5.1 框架准备 ✅
- [x] 扩展 `FeatureAggregator`，增加 `voiceProb`、`percussiveRatio` 等字段
- [x] 更新 `StyleDetector`/`fastHeuristic`，基于新字段输出 6-8 个主要曲风标签
- [x] 调整 `/api/analyze` Prompt/模板，引用新风格标签生成文案

### 2.5.2 人声检测接入 ✅
- [ ] 评估 WebRTC VAD 与 `onnxruntime-web`(YAMNet) 的性能差异 ⚠️ 未实现
- [ ] 在 Audio Worker 中集成人声检测，每 0.5-1s 产出 `voiceProb` ⚠️ 未实现
- [x] 将人声阈值加入风格判定与弹幕模板（区分纯器乐 / 主唱）
- [x] 融合 YAMNet 乐器概率与 Meyda 提示，平滑产出 `voiceProb`

### 2.5.3 打击乐/能量占比 ✅
- [ ] 实现简化 HPSS，计算 `percussiveRatio` 与 `harmonicRatio` ⚠️ 未实现
- [x] 将能量占比映射到 Techno/EDM/Rock 等风格触发条件
- [x] 记录调试日志，验证不同素材下的鲁棒性
- [x] 基于鼓类概率与能量特征平滑 `percussiveRatio` 并引入弹幕触发门控

### 2.5.4 乐器提示 ✅
- [ ] 引入轻量嵌入模型（OpenL3/VGGish wasm），每 2s 计算音色嵌入 ⚠️ 未实现
- [x] 建立简易分类器，输出 `synth/guitar/piano/strings` 等标签
- [x] 将乐器标签写入 FeatureWindow 与弹幕 Prompt，提升文案区分度

**验收标准**: 能辨别“有无人声”“打击乐主导”“核心乐器/音色”，弹幕文案对应曲风明显差异

---

## 🎯 Phase 2.6: 预训练乐器分类模型接入 ✅ 已完成 (80%)

### 2.6.1 模型评估与集成 ✅
- [ ] 评估 `musicnn` 与 `YAMNet` 浏览器版本的体积与性能 ⚠️ 未实现
- [ ] 在 Web Worker 中加载选定模型（优先 musicnn，备用 YAMNet） ⚠️ 未实现
- [x] 实现 0.5~1s 音频窗口预处理（16kHz/mono）并完成推理调用
- [x] 预置 `yamnet.task` 至 `public/model/` 并改为本地加载路径
- [x] 采用 YAMNet 作为当前默认模型，保留 musicnn 作为后续增强选项
- [ ] 输出 Worker 化方案（目前仍在主线程，需拆分） ⚠️ 未实现

### 2.6.2 概率映射与接口对接 ✅
- [x] 将模型输出映射为核心乐器标签（piano/guitar/synth/strings/drums/voice）
- [x] 将标签概率注入 `FeatureFrame` / `FeatureWindow`（如 `instrumentProb` 与 `dominantInstrument`）
- [x] 扩展 `StyleDetector` 与 `/api/analyze`，利用新标签选取弹幕模板

### 2.6.3 可视化与弹幕联动 ✅
- [ ] 为每类乐器定义视觉主题（配色、粒子/Shader 参数） ⚠️ 未实现
- [x] 更新弹幕模板库：针对不同乐器生成差异化评论语料
- [x] 在缺少模型输出时保持旧的启发式兜底逻辑

**验收标准**: 现实演奏音频能自动识别主导乐器，弹幕与可视化随乐器转换而变化

---

## 🎯 Phase 3: LLM集成 (中优先级)

### 3.1 真实API替换
- [ ] 集成Vercel AI SDK
- [ ] 实现LLM JSON模式调用
- [ ] 添加超时和错误处理
- [ ] 实现流式响应解析

### 3.2 Rule-based先验系统
- [ ] 实现快速风格判定 (<5ms)
- [ ] 创建风格模板库
- [ ] 实现fallback评论生成
- [ ] 添加本地缓存机制

### 3.3 评论生成优化
- [ ] 设计专业乐评Prompt
- [ ] 实现结构化JSON输出
- [ ] 添加评论质量验证
- [x] 实现批量生成和串行输出

### 3.4 缓存和性能
- [ ] 实现特征hash缓存
- [ ] 添加Edge缓存策略
- [ ] 实现缓存命中检测
- [ ] 优化冷启动时间

**预期时间**: 3-4天
**验收标准**: 首条评论<2s，全量评论<5s，支持弱网fallback

---

## 🎯 Phase 4: 性能优化 (低优先级)

### 4.1 WebWorker隔离
- [ ] 将特征提取移到WebWorker
- [ ] 实现主线程与Worker通信
- [ ] 添加Worker错误处理
- [ ] 优化数据传输效率

### 4.2 移动端优化
- [ ] 实现AudioWorklet优先，ScriptProcessor兜底
- [ ] 添加设备能力检测
- [ ] 优化iOS Safari兼容性
- [ ] 实现后台暂停/前台恢复

### 4.3 渲染性能优化
- [ ] 实现弹幕批量渲染
- [ ] 添加帧率监控和自适应
- [ ] 优化DOM操作频率
- [ ] 实现内存泄漏检测

### 4.4 网络优化
- [ ] 实现请求去重
- [ ] 添加网络状态检测
- [ ] 实现弱网降级策略
- [ ] 优化重试机制

**预期时间**: 2-3天
**验收标准**: 移动端流畅运行，内存使用稳定

---

## 🎯 Phase 5: 用户体验增强 (低优先级)

### 5.1 交互优化
- [ ] 添加弹幕密度调节
- [ ] 实现弹幕样式自定义
- [ ] 添加弹幕历史记录
- [ ] 实现弹幕互动功能

### 5.2 多语言支持
- [ ] 实现语言检测
- [ ] 添加多语言模板
- [ ] 实现语言切换
- [ ] 添加本地化配置

### 5.3 社交功能
- [ ] 实现弹幕分享
- [ ] 添加用户反馈
- [ ] 实现弹幕收藏
- [ ] 添加社区功能

**预期时间**: 3-4天
**验收标准**: 用户友好的交互体验

---

## 🎯 Phase 6: 测试和部署 (持续进行)

### 6.1 单元测试
- [ ] 特征提取测试
- [ ] 调度器逻辑测试
- [ ] API接口测试
- [ ] 错误处理测试

### 6.2 集成测试
- [ ] 端到端流程测试
- [ ] 移动端兼容性测试
- [ ] 性能压力测试
- [ ] 弱网环境测试

### 6.3 部署优化
- [ ] Vercel Edge配置优化
- [ ] CDN缓存策略
- [ ] 监控和告警
- [ ] 性能指标收集

**预期时间**: 持续进行
**验收标准**: 生产环境稳定运行

---

## 📊 当前状态总结

### ✅ 已完成
- 基础弹幕引擎 (固定轨道、变量速度、完整穿屏)
- 智能调度器 (驱动指标、抖动、迟滞)
- 流式客户端 (NDJSON解析)
- React Hook (生命周期管理)
- 移动端适配 (用户手势触发)
- 基础集成 (自动触发、状态显示)
- 弹幕节奏调度 (3-10s 随机间隔 + 评论缓冲队列)
- 本地 YAMNet 乐器分类链路（16k 预处理 + 特征映射 + Prompt 注入）
- 风格稳定度检测与触发状态机（质心/Chroma/Tempo + 滞回能量门控）
- **Phase 1: 特征提取增强 (100%完成)** - 核心特征提取、窗口聚合、统计计算、Loudness计算、特征归一化、验证和序列化
- **Phase 2: 稳定判定器 (100%完成)** - 风格稳定度检测、触发条件优化、风格分类器
- **Phase 2.5: 轻量曲风/乐器识别 (70%完成)** - 人声检测、打击乐占比、乐器提示
- **Phase 2.6: 预训练乐器分类模型接入 (80%完成)** - YAMNet集成、概率映射、弹幕联动

### 🟡 部分完成
- **Phase 1 剩余功能**: 无 - 已全部完成 ✅
- **Phase 2.5 剩余功能**: WebRTC VAD、Audio Worker、HPSS算法、轻量嵌入模型
- **Phase 2.6 剩余功能**: Web Worker化、musicnn评估、乐器视觉主题、差异化弹幕语料

### ❌ 待开始
- **Phase 3: LLM集成** (替换假数据API)
- **Phase 4: 性能优化** (WebWorker、缓存)
- **Phase 5: 用户体验增强** (自定义、多语言)
- **Phase 6: 测试和部署** (单元测试、集成测试、部署优化)

---

## 🚀 下一步行动

### 🎯 立即处理 (1-2周)
1. **Web Worker化实现**
   - 将YAMNet模型推理移到后台线程
   - 优化主线程性能
   - 实现Worker错误处理

2. **HPSS算法开发**
   - 实现简化的谐波-打击乐源分离
   - 提升乐器分类准确性
   - 优化能量占比计算

3. **测试补充**
   - 编写核心功能单元测试
   - 实现集成测试覆盖
   - 添加性能基准测试

### 🔧 短期目标 (2-4周)
1. **性能优化**
   - 实现特征缓存机制
   - 优化音频处理算法
   - 添加内存监控

2. **功能完善**
   - 实现Loudness计算
   - 添加特征归一化
   - 完善乐器特定主题

3. **用户体验提升**
   - 添加加载状态指示
   - 优化错误处理提示
   - 实现配置管理界面

### 🌟 中期目标 (1-2个月)
1. **LLM集成**
   - 集成真实Vercel AI SDK
   - 实现结构化JSON输出
   - 添加缓存和降级策略

2. **移动端优化**
   - 实现AudioWorklet支持
   - 优化iOS Safari兼容性
   - 添加后台暂停/恢复

3. **监控和分析**
   - 添加性能监控
   - 实现用户行为分析
   - 建立错误追踪系统

---

## 📝 技术债务

- [ ] 移除假数据API，集成真实LLM
- [ ] 添加完整的错误处理和日志
- [ ] 实现配置管理系统
- [ ] 添加性能监控和指标
- [ ] 完善文档和注释

---

## 🎯 成功指标

- **性能**: 首条评论<2s，全量评论<5s
- **稳定性**: 移动端流畅运行，无内存泄漏
- **准确性**: 风格判定准确率>80%
- **用户体验**: 弹幕流畅，无卡顿
- **兼容性**: 支持主流移动浏览器

---

*最后更新: 2024年12月*
*负责人: 开发团队*
*预计完成时间: 2-3周*
