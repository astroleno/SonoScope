# 弹幕组件开发 TODO

基于 `弹幕组件.md` 设计文档的完整实现计划

## 📋 总体进度

- [x] **Phase 0: 基础框架** - 已完成
- [ ] **Phase 1: 特征提取增强** - 进行中
- [ ] **Phase 2: 稳定判定器** - 待开始
- [ ] **Phase 3: LLM集成** - 待开始
- [ ] **Phase 4: 性能优化** - 待开始

---

## 🎯 Phase 1: 特征提取增强 (高优先级)

### 1.1 扩展Meyda特征提取器
- [ ] 添加Chroma特征提取 (12维)
- [ ] 添加PCP (Pitch Class Profile) 特征 (12维)
- [ ] 添加Spectral Contrast特征 (6维)
- [ ] 添加Spectral Bandwidth特征
- [ ] 添加Spectral Rolloff特征
- [ ] 添加Dynamic Range计算
- [ ] 添加Loudness (LKFS) 计算

### 1.2 实现2-4s窗口聚合
- [ ] 创建滑动窗口缓冲区
- [ ] 计算特征统计量 (均值/方差/峰值)
- [ ] 实现Tempo BPM估计 (每0.5-1s更新)
- [ ] 实现Beat Strength计算
- [ ] 添加特征平滑算法 (EMA)

### 1.3 特征数据接口标准化
- [ ] 定义完整的FeatureWindow接口
- [ ] 实现特征归一化函数
- [ ] 添加特征验证和边界检查
- [ ] 创建特征序列化/反序列化

**预期时间**: 2-3天
**验收标准**: 能够提取完整的音频特征集，支持2-4s窗口统计

---

## 🎯 Phase 2: 稳定判定器 (中优先级)

### 2.1 风格稳定度检测
- [ ] 实现Centroid方差检测
- [ ] 实现Chroma能量稳定性检测
- [ ] 实现Tempo变化率检测
- [ ] 添加稳定度阈值配置
- [ ] 实现1.5-2.0s持续时长检测

### 2.2 触发条件优化
- [ ] 实现多条件组合判定
- [ ] 添加迟滞机制防止抖动
- [ ] 实现触发状态机
- [ ] 添加调试日志和可视化

### 2.3 风格分类器
- [ ] 实现Rule-based风格判定
- [ ] 添加EDM/House/Techno等风格规则
- [ ] 实现风格置信度计算
- [ ] 添加风格切换检测

**预期时间**: 1-2天
**验收标准**: 能够稳定检测音频风格，避免频繁切换

---

## 🎯 Phase 3: LLM集成 (中优先级)

### 3.1 真实API替换
- [ ] 集成Vercel AI SDK
- [ ] 实现LLM JSON模式调用
- [ ] 添加超时和错误处理
- [ ] 实现流式响应解析

### 3.2 Rule-based先验系统
- [ ] 实现快速风格判定 (<5ms)
- [ ] 创建风格模板库
- [ ] 实现fallback评论生成
- [ ] 添加本地缓存机制

### 3.3 评论生成优化
- [ ] 设计专业乐评Prompt
- [ ] 实现结构化JSON输出
- [ ] 添加评论质量验证
- [ ] 实现批量生成和串行输出

### 3.4 缓存和性能
- [ ] 实现特征hash缓存
- [ ] 添加Edge缓存策略
- [ ] 实现缓存命中检测
- [ ] 优化冷启动时间

**预期时间**: 3-4天
**验收标准**: 首条评论<2s，全量评论<5s，支持弱网fallback

---

## 🎯 Phase 4: 性能优化 (低优先级)

### 4.1 WebWorker隔离
- [ ] 将特征提取移到WebWorker
- [ ] 实现主线程与Worker通信
- [ ] 添加Worker错误处理
- [ ] 优化数据传输效率

### 4.2 移动端优化
- [ ] 实现AudioWorklet优先，ScriptProcessor兜底
- [ ] 添加设备能力检测
- [ ] 优化iOS Safari兼容性
- [ ] 实现后台暂停/前台恢复

### 4.3 渲染性能优化
- [ ] 实现弹幕批量渲染
- [ ] 添加帧率监控和自适应
- [ ] 优化DOM操作频率
- [ ] 实现内存泄漏检测

### 4.4 网络优化
- [ ] 实现请求去重
- [ ] 添加网络状态检测
- [ ] 实现弱网降级策略
- [ ] 优化重试机制

**预期时间**: 2-3天
**验收标准**: 移动端流畅运行，内存使用稳定

---

## 🎯 Phase 5: 用户体验增强 (低优先级)

### 5.1 交互优化
- [ ] 添加弹幕密度调节
- [ ] 实现弹幕样式自定义
- [ ] 添加弹幕历史记录
- [ ] 实现弹幕互动功能

### 5.2 多语言支持
- [ ] 实现语言检测
- [ ] 添加多语言模板
- [ ] 实现语言切换
- [ ] 添加本地化配置

### 5.3 社交功能
- [ ] 实现弹幕分享
- [ ] 添加用户反馈
- [ ] 实现弹幕收藏
- [ ] 添加社区功能

**预期时间**: 3-4天
**验收标准**: 用户友好的交互体验

---

## 🎯 Phase 6: 测试和部署 (持续进行)

### 6.1 单元测试
- [ ] 特征提取测试
- [ ] 调度器逻辑测试
- [ ] API接口测试
- [ ] 错误处理测试

### 6.2 集成测试
- [ ] 端到端流程测试
- [ ] 移动端兼容性测试
- [ ] 性能压力测试
- [ ] 弱网环境测试

### 6.3 部署优化
- [ ] Vercel Edge配置优化
- [ ] CDN缓存策略
- [ ] 监控和告警
- [ ] 性能指标收集

**预期时间**: 持续进行
**验收标准**: 生产环境稳定运行

---

## 📊 当前状态总结

### ✅ 已完成
- 基础弹幕引擎 (固定轨道、变量速度、完整穿屏)
- 智能调度器 (驱动指标、抖动、迟滞)
- 流式客户端 (NDJSON解析)
- React Hook (生命周期管理)
- 移动端适配 (用户手势触发)
- 基础集成 (自动触发、状态显示)

### 🟡 进行中
- 特征提取增强 (需要添加Chroma、PCP等)
- 稳定判定器 (需要实现风格稳定度检测)

### ❌ 待开始
- LLM集成 (替换假数据API)
- 性能优化 (WebWorker、缓存)
- 用户体验增强 (自定义、多语言)

---

## 🚀 下一步行动

1. **立即开始**: Phase 1.1 - 扩展Meyda特征提取器
2. **并行进行**: 测试当前功能，收集用户反馈
3. **优先级**: 特征提取 → 稳定判定 → LLM集成 → 性能优化

---

## 📝 技术债务

- [ ] 移除假数据API，集成真实LLM
- [ ] 添加完整的错误处理和日志
- [ ] 实现配置管理系统
- [ ] 添加性能监控和指标
- [ ] 完善文档和注释

---

## 🎯 成功指标

- **性能**: 首条评论<2s，全量评论<5s
- **稳定性**: 移动端流畅运行，无内存泄漏
- **准确性**: 风格判定准确率>80%
- **用户体验**: 弹幕流畅，无卡顿
- **兼容性**: 支持主流移动浏览器

---

*最后更新: 2024年12月*
*负责人: 开发团队*
*预计完成时间: 2-3周*
