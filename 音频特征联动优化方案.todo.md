# 音频特征联动优化方案 TODO（Vercel 与移动端约束）

> 目标：在不引入新模型的前提下，优先落地“特征平滑 + 参数映射 + 弹幕时机/队列 + 性能稳定”四个能力，确保 Vercel 可部署、移动端稳定 30–60 FPS。

## 精选特征与派生信号（更新）
- 主特征（少而精）：RMS（能量包络）、三段能量 Bands（低/中/高）、频谱质心 Centroid、频谱通量 Flux（快速窗）、HPSS 打击乐占比 PercussiveRatio
- 派生信号（轻量提升敏感度）：
  - 多时间尺度平滑：fast(50–80ms)/mid(200–400ms)/slow(1–2s)
  - 一阶差分/突变：Δfast、(当前−mid)/mid，用于“敏锐度”与触发
  - 峰值事件（onset-like）：由 flux_fast 与 percussive_ratio 联合触发，带冷却
  - 轻量 BPM（可选，Wave 优先）：基于 onset 直方图或节拍自相关的 10–20s 滑窗估计，更新频率 0.2–0.5 Hz；失败时回退为拍点间隔均值

## Ⅰ. 立即采纳（不改后端/无需新模型）
- FeatureSmoother：快/中/慢三档指数平滑，统一归一化输出（rms、centroid、flux、zcr、HPSS 比例、音色亮度等）。
- FeatureMapper 基础映射：为 pulse / accretion / mosaic / wave / spiral 提供参数映射（粒子数/速度/颜色H/亮度/动画强度）。
- IntelligentTimingController（基础版）：峰值/突变/HPSS 转折触发点，控制弹幕生成时机与冷却。
- IntelligentDanmuQueue：优先级排序、重复去重、密度上限（5s 窗口）、移动端优先策略。
- 性能护栏：帧节流、对象池、轻量缓存（Worker 侧优先），保持渲染与特征常量级复杂度。

## Ⅱ. 优化后采纳（需小规模验证/调参）
- 动态样式映射：字体大小/色相/动效强度由“能量/亮度/紧张度（代理特征）”驱动；加可视参数面板与HUD可视化。
- Mosaic/Accretion 着色器增强：分批启用（feature flags），弱机降级为基础色表与低复杂度分支。
- 指标埋点：特征延迟、弹幕响应、FPS、内存占用；Vercel Analytics + 前端采样上报。

## Ⅲ. 暂缓（第二阶段再评审）
- EmotionAnalyzer / MusicStructureAnalyzer 真正算法或模型化；先以代理特征与规则近似。
- 预测性处理（LatencyOptimizer）与预渲染；需端上内存与能耗评估。
- 个性化学习与长期偏好建模（需存储与隐私评估）。

---

## 模式映射优化（含 BPM 与“巧思”）
- Wave（波形/频带线）
  - 线宽/透明度：low_band_slow
  - 波峰弹性/扰动：Δfast
  - 基色：centroid_mid
  - 节奏同步（新增）：
    - 若 BPM 可用：按 BPM/2 或 BPM 对齐波形相位/扫描速度，使峰谷与拍点同步
    - 若 BPM 不可用：按 onset 平均间隔自适应相位推进
- Mosaic（马赛克/像素格）
  - 瓦片细节度：high_band_slow（高频越强越细）
  - 边缘抖动：Δfast（突变增强细节）
  - 色相/亮度：centroid_mid + rms_slow
  - 横向“响度扫描”（新增巧思）：
    - 左→右两种模式可切换：
      1) 时间扫：最近 0.5–2s 的短历史环形缓冲，左旧右新，形成“能量流动条”
      2) 频段扫：左低频→右高频，先用低/中/高三段，细分时按 Bark/Mel 组簇
- Pulse（呼吸/粒子爆发）
  - 振幅/密度：rms_slow
  - 爆发触发：onset（flux_fast + percussive_ratio）
  - 颜色偏移：centroid_mid
- Accretion（聚合/扩散）
  - 聚合半径：mid_band_slow
  - 扩散速率：Δfast
  - 留痕强度：1 − percussive_ratio（谐波越强留痕越重）
- Spiral（螺旋/轨迹）
  - 半径/角速度：rms_slow
  - 轨迹扰动：Δfast
  - 拍点喷发：onset（带冷却）

### 其他轻量巧思（移动端友好）
- 立体声/声像偏移：若可用左右声道 RMS，水平位移/偏色随声像摆动（失败回退为 0）
- 对比增强：低能量段提高 Δfast 权重，高能量段降低，保证“弱段也有细节”
- 渐进色板：centroid_mid 跨阈切换色板时做 200–400ms 插值，避免“跳变刺眼”
- 自适应冷却：Δfast 极大时缩短 cool-down，增强强击穿透力

---

## 四个预设的“频谱优先”优化方案（落地清单）
- 总原则：以“频谱敏锐度”为最高优先，用少量特征表达清晰、稳定且细腻的变化；fast 捕捉细节，slow 定义稳态，Δfast/事件增强对比。

- Wave（频带线/波形）
  - 优先项：
    - 频带幅值映射：低/中/高三带分别驱动线宽/透明度/位移幅度（low→线宽、mid→透明度、high→抖动细节）
    - 相位/速度同步：若 BPM 可用按 BPM 或 BPM/2 对齐相位与扫描速度；无 BPM 用 onset 平均间隔
    - 灵敏度：Δfast 作为瞬态扰动叠加到线段顶点，限制在软阈内
  - 抖动治理：200–400ms 插值过渡，极端 Δfast 限幅；弱机时降低顶点数

- Mosaic（马赛克）
  - 优先项：
    - 左→右“响度扫描”：
      1) 时间扫：最近 1s 历史窗口（环形缓冲），左旧右新；
      2) 频段扫：左低频→右高频（3 段起步，进阶 Bark/Mel 簇），每列亮度=对应段归一能量
    - 细节度：由高频能量 high_band_slow 控制瓦片粒度；Δfast 增强边缘抖动
  - 抖动治理：列间做 2–3 邻域平滑；色板切换做 200–400ms 插值

- Accretion（聚合/扩散）
  - 优先项：
    - 中频能量 mid_band_slow 控制聚合半径（人声/旋律区域更稳态）
    - Δfast 控制扩散速率（瞬态更“爆”）
    - HPSS 打击占比 percussive_ratio 提升“爆粒”尺寸，谐波占比提升“留痕”
  - 抖动治理：扩散速率与半径做缓启/缓停，避免瞬间跳变

- Spiral（螺旋）
  - 优先项：
    - 全局半径/角速度：rms_slow（整体能量）
    - 轨迹微扰：Δfast（细节）
    - 拍点喷发：onset 触发粒子/尾迹爆点，冷却 200–400ms（强触发可缩短）
  - 抖动治理：角速度插值，喷发粒子数量做软限幅

说明：四预设均以“频谱驱动”为主线，颜色/亮度来自 centroid_mid 与 rms_slow 的组合，事件触发从 onset 派生；全链路遵循弱机降级与 O(1) 级计算。

## 交付检查清单（Vercel/移动端约束）
- Vercel
  - 模型与静态资源：`app/public/model/yamnet.task` 路径稳定可访问；构建时不内联大模型。
  - 打包体积：避免引入重依赖；动态 `import()` 大型可视化/调试模块。
  - Edge 限制：仅用于令牌/配置；新增逻辑不依赖服务器状态。
- 移动端
  - AudioContext 手势解锁与降噪开关提示；频繁 GC 避免（对象池）。
  - FPS 守护策略：<30fps 自动降低粒子/禁用高复杂度 shader 分支。
  - 内存上限：目标 <150MB；纹理与缓冲复用/释放。

---

## 里程碑（2–3 周）
1. 特征平滑与统一映射（D3）
2. 5 模式参数接入与回归（D5）
3. 弹幕时机与队列（D4）
4. 性能护栏与移动端降级（D3）
5. 调试 HUD 与参数面板（D2）
6. 指标埋点与 Vercel 验证（D2）
7. 轻量 BPM 估计与 Wave 相位同步（D2，失败回退保底）

---

## 任务分解
- [进行中] FeatureSmoother（快/中/慢）并接入特征输出
- [待办] FeatureMapper 基础映射并接入 5 种模式
- [待办] IntelligentTimingController（峰值/突变/HPSS 转折）基础版
- [待办] IntelligentDanmuQueue（优先级/去重/密度控制）
- [待办] 帧节流/对象池/缓存（移动端优先）
- [待办] 参数面板与调试 HUD（平滑、灵敏度、密度、FPS）
- [待办] 模式参数适配：Pulse/Accretion/Mosaic/Wave/Spiral 各3–4项
- [待办] Vercel 兼容性检查（资源路径、bundle 体积、Edge 限制）
- [待办] 移动端优化（解锁、降级、内存与FPS守护）
- [待办] 指标与埋点（延迟、响应、FPS、内存）
- [待办] 第二阶段预研：Emotion/Structure 代理方案
- [待办] 轻量 BPM 估计（onset 直方图/自相关），优先用于 Wave，相位同步
- [待办] Mosaic 左→右“响度扫描”实现（时间扫/频段扫可切换），弱机回退

---

## 验收标准
- 技术：特征延迟 <50ms；桌面 >55fps、移动端 >30fps；弹幕触发 <100ms；内存 <150MB。
- 体验：爆发时刻弹幕与节奏同步；重复率下降 ≥60%；模式切换视觉参数平稳。


