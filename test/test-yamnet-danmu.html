<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SonoScope YAMNet & å¼¹å¹•åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #000;
            color: #fff;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0052a3;
        }
        .test-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #1a4d1a;
            border: 1px solid #2d7d2d;
        }
        .status.error {
            background: #4d1a1a;
            border: 1px solid #7d2d2d;
        }
        .status.info {
            background: #1a3a4d;
            border: 1px solid #2d5a7d;
        }
        .log {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .danmu-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        .danmu-item {
            position: absolute;
            color: #fff;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            white-space: nowrap;
            pointer-events: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ SonoScope YAMNet & å¼¹å¹•åŠŸèƒ½æµ‹è¯•</h1>
        
        <!-- æµ‹è¯•æ§åˆ¶é¢æ¿ -->
        <div class="test-section">
            <h2>ğŸ§ª æµ‹è¯•æ§åˆ¶</h2>
            <button class="test-button" onclick="testModelAccess()">1. æµ‹è¯•æ¨¡å‹æ–‡ä»¶è®¿é—®</button>
            <button class="test-button" onclick="testAudioContext()">2. æµ‹è¯•éŸ³é¢‘ä¸Šä¸‹æ–‡</button>
            <button class="test-button" onclick="testYAMNetLoading()">3. æµ‹è¯•YAMNetåŠ è½½</button>
            <button class="test-button" onclick="testDanmuEngine()">4. æµ‹è¯•å¼¹å¹•å¼•æ“</button>
            <button class="test-button" onclick="testFullIntegration()">5. å®Œæ•´é›†æˆæµ‹è¯•</button>
            <button class="test-button" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <!-- çŠ¶æ€æ˜¾ç¤º -->
        <div class="test-section">
            <h2>ğŸ“Š æµ‹è¯•çŠ¶æ€</h2>
            <div id="status-container"></div>
        </div>

        <!-- æ—¥å¿—è¾“å‡º -->
        <div class="test-section">
            <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
            <div id="log-container" class="log"></div>
        </div>
    </div>

    <!-- å¼¹å¹•å®¹å™¨ -->
    <div id="danmu-container" class="danmu-container"></div>

    <script>
        // å…¨å±€å˜é‡
        let audioContext = null;
        let analyser = null;
        let stream = null;
        let yamnetModel = null;
        let danmuEngine = null;
        let testResults = {};

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('log-container');
            const logEntry = `[${timestamp}] ${message}\n`;
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusContainer = document.getElementById('status-container');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusContainer.appendChild(statusDiv);
        }

        function clearLogs() {
            document.getElementById('log-container').textContent = '';
            document.getElementById('status-container').innerHTML = '';
        }

        // æµ‹è¯•1: æ¨¡å‹æ–‡ä»¶è®¿é—®
        async function testModelAccess() {
            log('ğŸ” å¼€å§‹æµ‹è¯•æ¨¡å‹æ–‡ä»¶è®¿é—®...');
            updateStatus('æ­£åœ¨æµ‹è¯•æ¨¡å‹æ–‡ä»¶è®¿é—®...', 'info');
            
            try {
                const response = await fetch('/model/yamnet_tflite/yamnet.tflite');
                if (response.ok) {
                    const size = response.headers.get('content-length');
                    log(`âœ… YAMNetæ¨¡å‹æ–‡ä»¶å¯è®¿é—®ï¼Œå¤§å°: ${size} bytes`);
                    updateStatus('âœ… æ¨¡å‹æ–‡ä»¶è®¿é—®æˆåŠŸ', 'success');
                    testResults.modelAccess = true;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                log(`âŒ æ¨¡å‹æ–‡ä»¶è®¿é—®å¤±è´¥: ${error.message}`);
                updateStatus('âŒ æ¨¡å‹æ–‡ä»¶è®¿é—®å¤±è´¥', 'error');
                testResults.modelAccess = false;
            }
        }

        // æµ‹è¯•2: éŸ³é¢‘ä¸Šä¸‹æ–‡
        async function testAudioContext() {
            log('ğŸ¤ å¼€å§‹æµ‹è¯•éŸ³é¢‘ä¸Šä¸‹æ–‡...');
            updateStatus('æ­£åœ¨æµ‹è¯•éŸ³é¢‘ä¸Šä¸‹æ–‡...', 'info');
            
            try {
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æµè§ˆå™¨ä¸æ”¯æŒgetUserMedia');
                }
                
                if (!window.AudioContext && !window.webkitAudioContext) {
                    throw new Error('æµè§ˆå™¨ä¸æ”¯æŒAudioContext');
                }
                
                log('âœ… æµè§ˆå™¨æ”¯æŒæ£€æŸ¥é€šè¿‡');
                
                // è·å–éº¦å…‹é£æƒé™
                stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                log('âœ… éº¦å…‹é£æƒé™è·å–æˆåŠŸ');
                
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                const AudioContextCtor = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContextCtor({ latencyHint: 'interactive' });
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                
                // é…ç½®åˆ†æå™¨
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.5;
                source.connect(analyser);
                
                // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡è¿è¡Œ
                if (audioContext.state !== 'running') {
                    await audioContext.resume();
                }
                
                log(`âœ… éŸ³é¢‘ä¸Šä¸‹æ–‡åˆ›å»ºæˆåŠŸï¼ŒçŠ¶æ€: ${audioContext.state}ï¼Œé‡‡æ ·ç‡: ${audioContext.sampleRate}`);
                updateStatus('âœ… éŸ³é¢‘ä¸Šä¸‹æ–‡æµ‹è¯•æˆåŠŸ', 'success');
                testResults.audioContext = true;
                
            } catch (error) {
                log(`âŒ éŸ³é¢‘ä¸Šä¸‹æ–‡æµ‹è¯•å¤±è´¥: ${error.message}`);
                updateStatus('âŒ éŸ³é¢‘ä¸Šä¸‹æ–‡æµ‹è¯•å¤±è´¥', 'error');
                testResults.audioContext = false;
            }
        }

        // æµ‹è¯•3: YAMNetåŠ è½½
        async function testYAMNetLoading() {
            log('ğŸ§  å¼€å§‹æµ‹è¯•YAMNetæ¨¡å‹åŠ è½½...');
            updateStatus('æ­£åœ¨åŠ è½½YAMNetæ¨¡å‹...', 'info');
            
            try {
                // åŠ¨æ€å¯¼å…¥TensorFlow.js
                const tf = await import('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js');
                
                // å°è¯•åŠ è½½TFLiteæ¨¡å‹
                try {
                    log('å°è¯•åŠ è½½TFLiteæ¨¡å‹...');
                    const tfliteModule = await import('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tflite@0.0.1-alpha.8/dist/tf-tflite.min.js');
                    yamnetModel = await tfliteModule.loadTFLiteModel('/model/yamnet_tflite/yamnet.tflite');
                    log('âœ… TFLiteæ¨¡å‹åŠ è½½æˆåŠŸ');
                } catch (tfliteError) {
                    log(`TFLiteåŠ è½½å¤±è´¥ï¼Œå°è¯•TFJS: ${tfliteError.message}`);
                    // å›é€€åˆ°TFJS
                    yamnetModel = await tf.loadGraphModel('/model/yamnet/model.json');
                    log('âœ… TFJSæ¨¡å‹åŠ è½½æˆåŠŸ');
                }
                
                // æµ‹è¯•æ¨¡å‹æ¨ç†
                if (yamnetModel) {
                    const testInput = tf.tensor2d([new Array(15600).fill(0)], [1, 15600]);
                    const prediction = yamnetModel.predict(testInput);
                    const results = await prediction.data();
                    testInput.dispose();
                    prediction.dispose();
                    
                    log(`âœ… YAMNetæ¨ç†æµ‹è¯•æˆåŠŸï¼Œè¾“å‡ºç»´åº¦: ${results.length}`);
                    updateStatus('âœ… YAMNetæ¨¡å‹åŠ è½½æˆåŠŸ', 'success');
                    testResults.yamnet = true;
                } else {
                    throw new Error('æ¨¡å‹åŠ è½½å¤±è´¥');
                }
                
            } catch (error) {
                log(`âŒ YAMNetåŠ è½½å¤±è´¥: ${error.message}`);
                updateStatus('âŒ YAMNetåŠ è½½å¤±è´¥', 'error');
                testResults.yamnet = false;
            }
        }

        // æµ‹è¯•4: å¼¹å¹•å¼•æ“
        function testDanmuEngine() {
            log('ğŸ’¬ å¼€å§‹æµ‹è¯•å¼¹å¹•å¼•æ“...');
            updateStatus('æ­£åœ¨æµ‹è¯•å¼¹å¹•å¼•æ“...', 'info');
            
            try {
                // åˆ›å»ºç®€å•çš„å¼¹å¹•å¼•æ“
                danmuEngine = {
                    container: document.getElementById('danmu-container'),
                    danmuItems: new Map(),
                    isActive: false,
                    
                    start() {
                        this.isActive = true;
                        log('âœ… å¼¹å¹•å¼•æ“å¯åŠ¨');
                    },
                    
                    stop() {
                        this.isActive = false;
                        this.clearAll();
                        log('âœ… å¼¹å¹•å¼•æ“åœæ­¢');
                    },
                    
                    createDanmu(text) {
                        if (!this.isActive) return;
                        
                        const id = `danmu-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                        const element = document.createElement('div');
                        element.textContent = text;
                        element.className = 'danmu-item';
                        element.id = id;
                        
                        // è®¾ç½®æ ·å¼
                        element.style.fontSize = '16px';
                        element.style.color = '#fff';
                        element.style.textShadow = '2px 2px 4px rgba(0,0,0,0.8)';
                        element.style.position = 'absolute';
                        element.style.whiteSpace = 'nowrap';
                        element.style.pointerEvents = 'none';
                        element.style.userSelect = 'none';
                        element.style.zIndex = '1000';
                        
                        // éšæœºä½ç½®
                        const x = window.innerWidth + 50;
                        const y = Math.random() * (window.innerHeight - 100) + 50;
                        element.style.left = `${x}px`;
                        element.style.top = `${y}px`;
                        
                        this.container.appendChild(element);
                        
                        // åŠ¨ç”»
                        const duration = 8000 + Math.random() * 4000;
                        const speed = (window.innerWidth + 200) / duration * 16.67;
                        
                        const animate = () => {
                            const currentX = parseFloat(element.style.left);
                            const newX = currentX - speed;
                            element.style.left = `${newX}px`;
                            
                            if (newX > -200) {
                                requestAnimationFrame(animate);
                            } else {
                                element.remove();
                            }
                        };
                        
                        requestAnimationFrame(animate);
                        
                        log(`âœ… å¼¹å¹•åˆ›å»º: "${text}"`);
                    },
                    
                    clearAll() {
                        this.container.innerHTML = '';
                        this.danmuItems.clear();
                    }
                };
                
                // æµ‹è¯•å¼¹å¹•åˆ›å»º
                danmuEngine.start();
                danmuEngine.createDanmu('æµ‹è¯•å¼¹å¹•1: éŸ³é‡å¾ˆå¤§ï¼');
                danmuEngine.createDanmu('æµ‹è¯•å¼¹å¹•2: å¾ˆæœ‰åŠ›é‡ï¼');
                danmuEngine.createDanmu('æµ‹è¯•å¼¹å¹•3: éœ‡æ’¼ï¼');
                
                updateStatus('âœ… å¼¹å¹•å¼•æ“æµ‹è¯•æˆåŠŸ', 'success');
                testResults.danmu = true;
                
            } catch (error) {
                log(`âŒ å¼¹å¹•å¼•æ“æµ‹è¯•å¤±è´¥: ${error.message}`);
                updateStatus('âŒ å¼¹å¹•å¼•æ“æµ‹è¯•å¤±è´¥', 'error');
                testResults.danmu = false;
            }
        }

        // æµ‹è¯•5: å®Œæ•´é›†æˆæµ‹è¯•
        async function testFullIntegration() {
            log('ğŸ”„ å¼€å§‹å®Œæ•´é›†æˆæµ‹è¯•...');
            updateStatus('æ­£åœ¨è¿›è¡Œå®Œæ•´é›†æˆæµ‹è¯•...', 'info');
            
            try {
                // æ£€æŸ¥æ‰€æœ‰å‰ç½®æ¡ä»¶
                if (!testResults.modelAccess) {
                    throw new Error('æ¨¡å‹æ–‡ä»¶è®¿é—®å¤±è´¥');
                }
                if (!testResults.audioContext) {
                    throw new Error('éŸ³é¢‘ä¸Šä¸‹æ–‡æœªå°±ç»ª');
                }
                if (!testResults.yamnet) {
                    throw new Error('YAMNetæ¨¡å‹æœªåŠ è½½');
                }
                if (!testResults.danmu) {
                    throw new Error('å¼¹å¹•å¼•æ“æœªå°±ç»ª');
                }
                
                log('âœ… æ‰€æœ‰å‰ç½®æ¡ä»¶æ£€æŸ¥é€šè¿‡');
                
                // æ¨¡æ‹ŸéŸ³é¢‘åˆ†æ
                if (analyser && audioContext) {
                    const bufferLength = analyser.fftSize;
                    const timeDomainData = new Float32Array(bufferLength);
                    analyser.getFloatTimeDomainData(timeDomainData);
                    
                    // è®¡ç®—RMS
                    let sumSquares = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        sumSquares += timeDomainData[i] * timeDomainData[i];
                    }
                    const rms = Math.sqrt(sumSquares / bufferLength);
                    
                    log(`âœ… éŸ³é¢‘åˆ†ææˆåŠŸï¼ŒRMS: ${rms.toFixed(3)}`);
                    
                    // æ ¹æ®éŸ³é¢‘ç‰¹å¾ç”Ÿæˆå¼¹å¹•
                    if (rms > 0.1) {
                        const messages = [
                            'éŸ³é‡å¾ˆå¤§ï¼', 'å¾ˆæœ‰åŠ›é‡ï¼', 'éœ‡æ’¼ï¼',
                            'éŸ³é‡é€‚ä¸­', 'å¬èµ·æ¥ä¸é”™', 'å¾ˆå¥½å¬',
                            'éŸ³è‰²å¾ˆäº®', 'é«˜éŸ³å¾ˆæ¸…æ™°', 'å¾ˆæ¸…è„†'
                        ];
                        const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                        danmuEngine.createDanmu(randomMessage);
                        log(`âœ… åŸºäºéŸ³é¢‘ç‰¹å¾ç”Ÿæˆå¼¹å¹•: "${randomMessage}"`);
                    }
                }
                
                // æ¨¡æ‹ŸYAMNetåˆ†ç±»
                if (yamnetModel) {
                    const testBuffer = new Float32Array(15600);
                    for (let i = 0; i < 15600; i++) {
                        testBuffer[i] = Math.random() * 0.1; // æ¨¡æ‹ŸéŸ³é¢‘æ•°æ®
                    }
                    
                    const input = tf.tensor2d([Array.from(testBuffer)], [1, 15600]);
                    const prediction = yamnetModel.predict(input);
                    const results = await prediction.data();
                    input.dispose();
                    prediction.dispose();
                    
                    // æ‰¾åˆ°æœ€é«˜ç½®ä¿¡åº¦çš„ç±»åˆ«
                    const maxIndex = results.indexOf(Math.max(...results));
                    log(`âœ… YAMNetåˆ†ç±»å®Œæˆï¼Œæœ€é«˜ç½®ä¿¡åº¦ç±»åˆ«: ${maxIndex}, ç½®ä¿¡åº¦: ${results[maxIndex].toFixed(3)}`);
                    
                    // æ ¹æ®åˆ†ç±»ç»“æœç”Ÿæˆå¼¹å¹•
                    if (maxIndex < 100) {
                        danmuEngine.createDanmu('æ£€æµ‹åˆ°è¯­éŸ³å†…å®¹');
                    } else if (maxIndex < 200) {
                        danmuEngine.createDanmu('æ£€æµ‹åˆ°éŸ³ä¹å†…å®¹');
                    } else {
                        danmuEngine.createDanmu('æ£€æµ‹åˆ°ç¯å¢ƒå£°éŸ³');
                    }
                }
                
                updateStatus('âœ… å®Œæ•´é›†æˆæµ‹è¯•æˆåŠŸ', 'success');
                log('ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼YAMNetå’Œå¼¹å¹•åŠŸèƒ½è¿è¡Œæ­£å¸¸');
                
            } catch (error) {
                log(`âŒ å®Œæ•´é›†æˆæµ‹è¯•å¤±è´¥: ${error.message}`);
                updateStatus('âŒ å®Œæ•´é›†æˆæµ‹è¯•å¤±è´¥', 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ğŸš€ æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            log('ğŸ“‹ è¯·æŒ‰é¡ºåºç‚¹å‡»æµ‹è¯•æŒ‰é’®è¿›è¡ŒåŠŸèƒ½éªŒè¯');
            log('ğŸ’¡ å»ºè®®æµ‹è¯•é¡ºåº: 1â†’2â†’3â†’4â†’5');
        });

        // å®šæœŸç”Ÿæˆæµ‹è¯•å¼¹å¹•
        setInterval(() => {
            if (danmuEngine && danmuEngine.isActive) {
                const testMessages = [
                    'è‡ªåŠ¨æµ‹è¯•å¼¹å¹•1', 'è‡ªåŠ¨æµ‹è¯•å¼¹å¹•2', 'è‡ªåŠ¨æµ‹è¯•å¼¹å¹•3',
                    'éŸ³é‡æ£€æµ‹ä¸­...', 'éŸ³é¢‘åˆ†æè¿›è¡Œä¸­', 'YAMNetåˆ†ç±»ä¸­...'
                ];
                const randomMessage = testMessages[Math.floor(Math.random() * testMessages.length)];
                danmuEngine.createDanmu(randomMessage);
            }
        }, 5000);
    </script>
</body>
</html>
